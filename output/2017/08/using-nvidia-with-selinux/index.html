<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Using nVidia with SELinux - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.siphos.be/2017/08/using-nvidia-with-selinux/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="gentoo,selinux,nvidia" />
        <meta name="description" content="Yesterday I&#39;ve switched to the gentoo-sources kernel package on Gentoo Linux. And with that, I also attempted (succesfully) to use the propriatary nvidia drivers so that I can enjoy both a smoother 3D experience while playing minecraft, as well as use the CUDA support so I don&#39;t need to use …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Using nVidia with SELinux"/>
        <meta property="og:url" content="http://blog.siphos.be/2017/08/using-nvidia-with-selinux/"/>
        <meta property="og:description" content="Yesterday I&#39;ve switched to the gentoo-sources kernel package on Gentoo Linux. And with that, I also attempted (succesfully) to use the propriatary nvidia drivers so that I can enjoy both a smoother 3D experience while playing minecraft, as well as use the CUDA support so I don&#39;t need to use …"/>
        <meta property="article:published_time" content="2017-08-23" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:tag" content="gentoo" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:tag" content="nvidia" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="http://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="http://blog.siphos.be/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>



        <link href="http://blog.siphos.be/feeds/selinux.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="http://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.siphos.be/2017/08/using-nvidia-with-selinux/"
                       rel="bookmark"
                       title="Permalink to Using nVidia with SELinux">
                        Using nVidia with SELinux
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-08-23T19:04:00+02:00"> Wed 23 August 2017</time>
    </span>


            <span class="label label-default">By</span>
            <a href="http://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="http://blog.siphos.be/category/selinux.html">SELinux</a>


<span class="label label-default">Tags</span>
	<a href="http://blog.siphos.be/tag/gentoo/">gentoo</a>
        /
	<a href="http://blog.siphos.be/tag/selinux/">selinux</a>
        /
	<a href="http://blog.siphos.be/tag/nvidia/">nvidia</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Yesterday I've <a href="http://blog.siphos.be/2017/08/switch-to-gentoo-sources/">switched to the gentoo-sources kernel package</a> on Gentoo Linux.
And with that, I also attempted (succesfully) to use the propriatary nvidia drivers
so that I can enjoy both a smoother 3D experience while playing minecraft, as well
as use the CUDA support so I don't need to use cloud-based services for small
exercises.</p>
<p>The move to nvidia was quite simple, as the <a href="https://wiki.gentoo.org/wiki/NVidia/nvidia-drivers">nvidia-drivers wiki article</a> on
the Gentoo wiki was quite easy to follow.</p>


<p><strong>Signing the modules</strong></p>
<p>One difference I found with the article (which I've promply changed) is that
the signing command, necessary to sign the Linux kernel modules so that they
can be loaded (as unsigned or wrongly signed modules are not allowed on the
system), was different.</p>
<p>It used to be as follows (example for a single module, it had to be repeated
for each affected kernel module):</p>
<div class="highlight"><pre><span></span><code>~# perl /usr/src/linux/scripts/sign-file sha512 \
      /usr/src/linux/signing_key.priv \
      /usr/src/linux/signing_key.x509 \
      /lib/modules/4.12.5-gentoo/video/nvidia-uvm.ko
</code></pre></div>


<p>However, from version 4.3.3 onward (as also explained by this excellent
<a href="https://wiki.gentoo.org/wiki/Signed_kernel_module_support">Signed kernel module support article</a> on the Gentoo wiki) this command
no longer uses a Perl script, but is an ELF binary. Also, the location
of the default signing key is moved into a <code>certs/</code> subdirectory.</p>
<p><strong>Enabling nvidia device files</strong></p>
<p>When the nvidia modules are loaded, additional device files are enabled.
One is the <code>nvidia0</code> character device file, while the other is the
<code>nvidiactl</code> character device file. And although I can imagine that the
<code>nvidiactl</code> one is a control-related device file, I don't exactly know
for sure.</p>
<p>However, attempts to use 3D applications showed (through SELinux denials)
that access to these device files is needed. Without that, applications just
crashed, like so:</p>
<div class="highlight"><pre><span></span><code>org.lwjgl.LWJGLException: X Error - disp: 0x7fd164907b00 serial: 150 error: BadValue (integer parameter out of range for operation) request_code: 153 minor_code: 24
        at org.lwjgl.opengl.LinuxDisplay.globalErrorHandler(LinuxDisplay.java:320)
        at org.lwjgl.opengl.LinuxContextImplementation.nCreate(Native Method)
        at org.lwjgl.opengl.LinuxContextImplementation.create(LinuxContextImplementation.java:51)
        at org.lwjgl.opengl.ContextGL.&lt;init&gt;(ContextGL.java:132)
        at org.lwjgl.opengl.Display.create(Display.java:850)
        at org.lwjgl.opengl.Display.create(Display.java:757)
        at org.lwjgl.opengl.Display.create(Display.java:739)
        at bib.at(SourceFile:635)
        at bib.aq(SourceFile:458)
        at bib.a(SourceFile:404)
        at net.minecraft.client.main.Main.main(SourceFile:123)
</code></pre></div>


<p>Not really useful to debug for me, but the SELinux denials were a bit more obvious,
showing requests for read and write to the <code>nvidiactl</code> character device.</p>
<p>Thanks to <code>matchpathcon</code> I found out that the device files had to have the
<code>xserver_misc_device_t</code> type (which they didn't have to begin with, as the device
files were added after the automated <code>restorecon</code> was done on the <code>/dev</code> location).</p>
<p>So, adding the following command to my local init script fixed the context setting
at boot up:</p>
<div class="highlight"><pre><span></span><code>restorecon /dev/nvidiactl /dev/nvidia0
</code></pre></div>


<p>Also, the domains that needed to use nVidia had to receive the following
addition SELinux-policy-wise:</p>
<div class="highlight"><pre><span></span><code>dev_rw_xserver_misc(...)
</code></pre></div>


<p>Perhaps this can be made more fine-grained (as there are several other device
files marked as <code>xserver_misc_device_t</code>) but for now this should suffice.</p>
<p><strong>Optimus usage with X server</strong></p>
<p>The other challenge I had was that my workstation uses an integrated Intel
device, and offloads calculations and rendering to nVidia. The detection by
X server did not work automatically though, and it took some fiddling to get
it to work.</p>
<p>In the end, I had to add in an <code>nvidia.conf</code> file inside <code>/etc/X11/xorg.conf.d</code>
with the following content:</p>
<div class="highlight"><pre><span></span><code>Section &quot;ServerLayout&quot;
        Identifier      &quot;layout&quot;
        Screen  0       &quot;nvidia&quot;
        Inactive        &quot;intel&quot;
EndSection

Section &quot;Device&quot;
        Identifier      &quot;nvidia&quot;
        Driver          &quot;nvidia&quot;
        BusID           &quot;PCI:1:0:0&quot;
EndSection

Section &quot;Screen&quot;
        Identifier      &quot;nvidia&quot;
        Device          &quot;nvidia&quot;
        Option          &quot;AllowEmptyInitialConfiguration&quot;
EndSection

Section &quot;Device&quot;
        Identifier      &quot;intel&quot;
        Driver          &quot;modesetting&quot;
EndSection

Section &quot;Screen&quot;
        Identifier      &quot;intel&quot;
        Device          &quot;intel&quot;
EndSection
</code></pre></div>


<p>And with a single <code>xrandr</code> command I re-enabled split screen support (as by
default it now showed the same output on both screens):</p>
<div class="highlight"><pre><span></span><code>~$ xrandr --output eDP-1-1 --left-of HDMI-1-2
</code></pre></div>


<p>I also had to set the output source to the nVidia device, by adding the following
lines to my <code>~/.xinitrc</code> file:</p>
<div class="highlight"><pre><span></span><code>xrandr --setprovideroutputsource modesetting NVIDIA-0
xrandr --auto
</code></pre></div>


<p>And with that, another thing was crossed off from my TODO list. Which has become
quite large after my holidays (went to Kos, Greece) as I had many books and articles
on my ebook reader with me, which inspired a lot.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'using-nvidia-with-selinux';
                var disqus_url = 'http://blog.siphos.be/2017/08/using-nvidia-with-selinux/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>