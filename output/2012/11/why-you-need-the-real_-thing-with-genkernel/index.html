<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Why you need the real_* thing with genkernel - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.siphos.be/2012/11/why-you-need-the-real_-thing-with-genkernel/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="description" content="Today it bit me. I rebooted my workstation, and all hell broke loose. Well, actually, it froze. Literally, if you consider my root file system. When the system tried to remount the root file system read-write, it gave me this: mount: / not mounted or bad option So I did the …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Why you need the real_* thing with genkernel"/>
        <meta property="og:url" content="http://blog.siphos.be/2012/11/why-you-need-the-real_-thing-with-genkernel/"/>
        <meta property="og:description" content="Today it bit me. I rebooted my workstation, and all hell broke loose. Well, actually, it froze. Literally, if you consider my root file system. When the system tried to remount the root file system read-write, it gave me this: mount: / not mounted or bad option So I did the …"/>
        <meta property="article:published_time" content="2012-11-25" />
            <meta property="article:section" content="Gentoo" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="http://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="http://blog.siphos.be/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>



        <link href="http://blog.siphos.be/feeds/gentoo.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... Gentoo ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="http://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.siphos.be/2012/11/why-you-need-the-real_-thing-with-genkernel/"
                       rel="bookmark"
                       title="Permalink to Why you need the real_* thing with genkernel">
                        Why you need the real_* thing with genkernel
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2012-11-25T21:05:00+01:00"> Sun 25 November 2012</time>
    </span>


            <span class="label label-default">By</span>
            <a href="http://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="http://blog.siphos.be/category/gentoo.html">Gentoo</a>


    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Today it bit me. I rebooted my workstation, and all hell broke loose.
Well, actually, it froze. Literally, if you consider my root file
system. When the system tried to remount the root file system
read-write, it gave me this:</p>
<div class="highlight"><pre><span></span><code>mount: / not mounted or bad option
</code></pre></div>


<p>So I did the first thing that always helps me, and that is to disable
the initramfs booting and boot straight from the kernel. Now for those
wondering why I boot with an initramfs while it still works directly
with a kernel: it's a safety measure. Ever since there are talks,
rumours, fear, uncertainty and doubt about supporting a separate /usr
file system I started supporting an initramfs on my system in case an
update really breaks the regular boot cycle. Same because I use lvm on
most file systems, and software RAID on all of them. If I wouldn't have
an initramfs laying around, I would be screwed the moment userspace
decides not to support this straight from a kernel boot. Luckily, this
isn't the case (yet) so I could continue working without an initramfs.
But I digress. Back to the situation.</p>
<p>Booting without initramfs worked without errors of any kind. Next thing
is to investigate why it fails. I reboot back with the initramfs, get my
read-only root file system and start looking around. In my <strong>dmesg</strong>
output, I notice the following:</p>
<div class="highlight"><pre><span></span><code>EXT4-fs (md3): Cannot change data mode on remount
</code></pre></div>


<p>So that's weird, not? What is this data mode? Well, the <a href="https://www.kernel.org/doc/Documentation/filesystems/ext4.txt">data
mode</a>
tells the file system (ext4 for me) how to handle writing data to disk.
As you are all aware, ext4 is a journaled file system, meaning it writes
changes into a journal before applying, allowing changes to be replayed
when the system suddenly crashes. By default, ext4 uses ordered mode,
writing the metadata (information about files and such, like inode
information, timestamps, block maps, extended attributes, ... but not
the data itself) to the journal right after writing data to the disk,
after which the metadata is then written to disk as well.</p>
<p>On my system though, I use <code>data=journal</code> so data too is written to the
journal first. This gives a higher degree of protection in case of a
system crash (or immediate powerdown - my laptop doesn't recognize
batteries anymore and with a daughter playing around, I've had my share
of sudden powerdowns). I do boot with the <code>rootflags=data=journal</code> and I
have <code>data=journal</code> in my fstab.</p>
<p>But the above error tells me otherwise. It tells me that the mode is not
what I want it to be. So after fiddling a bit with the options and (of
course) using Google to find more information, I found out that my
initramfs doesn't check the <e>rootflags</e> parameter, so it mounts the
root file system with the standard (ordered) mode. Trying to remount it
later will fail, as my fstab contains the <code>data=journal</code> tag, and
running <strong>mount -o remount,rw,data=ordered</strong> for fun doesn't give many
smiles.</p>
<p>The man page for <strong>genkernel</strong> however showed me that it uses
<code>real_rootflags</code>. So I reboot with that parameter set to
<code>real_rootflags=data=journal</code> and all is okay again.</p>
<p><em>Edit:</em> I wrote that even changing the default mount options in the file
system itself (using <strong>tune2fs /dev/md3 -o journal_data</strong>) didn't help.
However, that seems to be an error on my part, I didn't reboot after
toggling this, which is apparently required. Thanks to Xake for pointing
that out.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'why-you-need-the-real_-thing-with-genkernel';
                var disqus_url = 'http://blog.siphos.be/2012/11/why-you-need-the-real_-thing-with-genkernel/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>