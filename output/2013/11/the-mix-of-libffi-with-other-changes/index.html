<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>The mix of libffi with other changes - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.siphos.be/2013/11/the-mix-of-libffi-with-other-changes/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="Gentoo,hardened,libffi,portage,selinux" />
        <meta name="description" content="I once again came across libffi. Not only does the libffi approach fight with SELinux alone, it also triggers the TPE (Trusted Path Execution) protections in grSecurity. And when I tried to reinstall Portage, Portage seemed to create some sort of runtime environment in a temporary directory as well, and …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="The mix of libffi with other changes"/>
        <meta property="og:url" content="http://blog.siphos.be/2013/11/the-mix-of-libffi-with-other-changes/"/>
        <meta property="og:description" content="I once again came across libffi. Not only does the libffi approach fight with SELinux alone, it also triggers the TPE (Trusted Path Execution) protections in grSecurity. And when I tried to reinstall Portage, Portage seemed to create some sort of runtime environment in a temporary directory as well, and …"/>
        <meta property="article:published_time" content="2013-11-03" />
            <meta property="article:section" content="Security" />
            <meta property="article:tag" content="Gentoo" />
            <meta property="article:tag" content="hardened" />
            <meta property="article:tag" content="libffi" />
            <meta property="article:tag" content="portage" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="http://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="http://blog.siphos.be/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>



        <link href="http://blog.siphos.be/feeds/security.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... Security ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="http://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.siphos.be/2013/11/the-mix-of-libffi-with-other-changes/"
                       rel="bookmark"
                       title="Permalink to The mix of libffi with other changes">
                        The mix of libffi with other changes
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-11-03T10:27:00+01:00"> Sun 03 November 2013</time>
    </span>


            <span class="label label-default">By</span>
            <a href="http://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="http://blog.siphos.be/category/security.html">Security</a>


<span class="label label-default">Tags</span>
	<a href="http://blog.siphos.be/tag/gentoo/">Gentoo</a>
        /
	<a href="http://blog.siphos.be/tag/hardened/">hardened</a>
        /
	<a href="http://blog.siphos.be/tag/libffi/">libffi</a>
        /
	<a href="http://blog.siphos.be/tag/portage/">portage</a>
        /
	<a href="http://blog.siphos.be/tag/selinux/">selinux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I <a href="http://blog.siphos.be/2013/04/securely-handling-libffi/">once again</a>
came across libffi. Not only does the libffi approach fight with SELinux
alone, it also triggers the TPE (Trusted Path Execution) protections in
grSecurity. And when I tried to reinstall Portage, Portage seemed to
create some sort of runtime environment in a temporary directory as
well, and SELinux wasn't up to allowing that either.</p>
<p>Let's first talk about a quick workaround for the libffi-with-TPE issue.
Because libffi wants to create executable files in a world-writable
directory and then execute that file (try finding the potential security
issue here) TPE is prohibiting the execution. The easiest workaround is
to add the <code>portage</code> Linux user, as well as the Linux accounts that you
use to run emerge with (even just things like <strong>emerge --info</strong>) in the
<code>wheel</code> group. This group is exempt from TPE protections (unless you
configured a different group in your kernel for this:</p>
<div class="highlight"><pre><span></span><code>~# zgrep CONFIG_GRKERNSEC_TPE_TRUSTED_GID /proc/config.gz
CONFIG_GRKERNSEC_TPE_TRUSTED_GID=10
</code></pre></div>


<p>Next we also need to allow the <code>portage_t</code> domain to execute files
labeled with <code>portage_tmpfs_t</code>. You can do this by creating your own
SELinux policy module with the following content (or use selocal):</p>
<div class="highlight"><pre><span></span><code>can_exec(portage_t, portage_tmpfs_t)
</code></pre></div>


<p>This works around the libffi issue for now. A better solution still has
to be implemented (as discussed in the previous post).</p>
<p>With regards to the portage installation failing, you'll notice this
quickly when you get an error like so:</p>
<div class="highlight"><pre><span></span><code>~# emerge -1 portage
Calculating dependencies  ... done!
Traceback (most recent call last):
  File &quot;/usr/bin/emerge&quot;, line 50, in &lt;module&gt;
    retval = emerge_main()
  File &quot;/usr/lib64/portage/pym/_emerge/main.py&quot;, line 1031, in emerge_main
    return run_action(emerge_config)
  File &quot;/usr/lib64/portage/pym/_emerge/actions.py&quot;, line 4062, in run_action
    emerge_config.args, spinner)
  File &quot;/usr/lib64/portage/pym/_emerge/actions.py&quot;, line 453, in action_build
    retval = mergetask.merge()
  File &quot;/usr/lib64/portage/pym/_emerge/Scheduler.py&quot;, line 946, in merge
    rval = self._handle_self_update()
  File &quot;/usr/lib64/portage/pym/_emerge/Scheduler.py&quot;, line 316, in _handle_self_update
    _prepare_self_update(self.settings)
  File &quot;/usr/lib64/portage/pym/portage/package/ebuild/doebuild.py&quot;, line 2326, in _prepare_self_update
    shutil.copytree(orig_bin_path, portage._bin_path, symlinks=True)
  File &quot;/usr/lib64/portage/pym/portage/__init__.py&quot;, line 259, in __call__
    rval = self._func(*wrapped_args, **wrapped_kwargs)
  File &quot;/usr/lib64/python3.3/shutil.py&quot;, line 343, in copytree
    raise Error(errors)
shutil.Error: [(b&#39;/usr/lib64/portage/bin/ebuild-helpers/prepalldocs&#39;, 
b&#39;/var/tmp/portage/._portage_reinstall_.osj370/bin/ebuild-helpers/prepalldocs&#39;, 
&quot;[Errno 13] Permission denied: &#39;/var/tmp/portage/._portage_reinstall_.osj370/bin/ebuild-helpers/prepalldocs&#39;&quot;), 
(b&#39;/usr/lib64/portage/bin/ebuild-helpers/prepinfo&#39;, 
b&#39;/var/tmp/portage/._portage_reinstall_.osj370/bin/ebuild-helpers/prepinfo&#39;, 
&quot;[Errno 13] Permission denied: &#39;/var/tmp/portage/._portage_reinstall_.osj370/bin/ebuild-helpers/prepinfo&#39;&quot;), 
(b&#39;/usr/lib64/portage/bin/ebuild-helpers/newlib.so&#39;, 
b&#39;/var/tmp/portage/._portage_reinstall_.osj370/bin/ebuild-helpers/newlib.so&#39;, 
&quot;[Errno 13] Permission denied: &#39;/var/tmp/portage/._portage_reinstall_.osj370/bin/ebuild-helpers/newlib.so&#39;&quot;), 
[...]
</code></pre></div>


<p>And the errors go on and on and on.</p>
<p>I've been able to get it working again by allowing the following SELinux
permissions:</p>
<div class="highlight"><pre><span></span><code>allow portage_t portage_tmp_t:dir relabel_dir_perms;
allow portage_t portage_tmp_t:lnk_file relabel_lnk_file_perms;
allow portage_t bin_t:dir relabel_dir_perms;
allow portage_t bin_t:file relabel_file_perms;
allow portage_t bin_t:lnk_file relabel_lnk_file_perms;
allow portage_t portage_exec_t:file relabel_file_perms;
allow portage_t portage_fetch_exec_t:file relabel_file_perms;
allow portage_t lib_t:dir relabel_dir_perms;
allow portage_t lib_t:file relabel_file_perms;
</code></pre></div>


<p>You can somewhat shorten this by combining types (but this doesn't work
with selocal for now):</p>
<div class="highlight"><pre><span></span><code>allow portage_t { portage_tmp_t bin_t lib_t}:dir relabel_dir_perms;
allow portage_t { portage_tmp_t bin_t }:lnk_file relabel_lnk_file_perms;
allow portage_t { bin_t portage_exec_t portage_fetch_exec_t lib_t}:file relabel_file_perms;
</code></pre></div>


<p>At the end of the emerge process (when the new portage is installed) you
might want to reset the labels of all files provided by the portage
package:</p>
<div class="highlight"><pre><span></span><code>~# rlpkg portage
</code></pre></div>


<p>These changes have not been passed into the policy yet as I first need
to find out why exactly they are needed, and as you can see from <a href="http://dev.gentoo.org/devaway/">the
gentoo devaway</a> page, time is not on my
side to do this. I'll try to free up some time in the next few days to
handle this as well as the <a href="http://userspace.selinuxproject.org/trac/wiki/Releases">SELinux userspace
release</a> but no
promises here.</p>
<p><em>Edit:</em> I found why - it is the <code>_prepare_self_update</code> in the
<code>doebuild.py</code> script. It creates temporary copies of the Portage
binaries and Portage python libraries, which is why we need to support
relabel operations on the files. Support for this is now in the policy
repository.</p>
</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'the-mix-of-libffi-with-other-changes';
                var disqus_url = 'http://blog.siphos.be/2013/11/the-mix-of-libffi-with-other-changes/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>