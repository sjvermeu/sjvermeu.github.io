<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Looking at the local Linux kernel privilege escalation - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.siphos.be/2013/05/looking-at-the-local-linux-kernel-privilege-escalation/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="event,grsecurity,kernexec,linux,pax,perf,selinux,uderef,vulnerability" />
        <meta name="description" content="There has been a few posts already on the local Linux kernel privilege escalation, which has received the CVE-2013-2094 ID. arstechnica has a write-up with links to good resources on the Internet, but I definitely want to point readers to the explanation that Brad Spengler made on the vulnerability. In …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Looking at the local Linux kernel privilege escalation"/>
        <meta property="og:url" content="http://blog.siphos.be/2013/05/looking-at-the-local-linux-kernel-privilege-escalation/"/>
        <meta property="og:description" content="There has been a few posts already on the local Linux kernel privilege escalation, which has received the CVE-2013-2094 ID. arstechnica has a write-up with links to good resources on the Internet, but I definitely want to point readers to the explanation that Brad Spengler made on the vulnerability. In …"/>
        <meta property="article:published_time" content="2013-05-17" />
            <meta property="article:section" content="Security" />
            <meta property="article:tag" content="event" />
            <meta property="article:tag" content="grsecurity" />
            <meta property="article:tag" content="kernexec" />
            <meta property="article:tag" content="linux" />
            <meta property="article:tag" content="pax" />
            <meta property="article:tag" content="perf" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:tag" content="uderef" />
            <meta property="article:tag" content="vulnerability" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="http://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="http://blog.siphos.be/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>



        <link href="http://blog.siphos.be/feeds/security.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... Security ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="http://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.siphos.be/2013/05/looking-at-the-local-linux-kernel-privilege-escalation/"
                       rel="bookmark"
                       title="Permalink to Looking at the local Linux kernel privilege escalation">
                        Looking at the local Linux kernel privilege escalation
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-05-17T03:50:00+02:00"> Fri 17 May 2013</time>
    </span>


            <span class="label label-default">By</span>
            <a href="http://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="http://blog.siphos.be/category/security.html">Security</a>


<span class="label label-default">Tags</span>
	<a href="http://blog.siphos.be/tag/event/">event</a>
        /
	<a href="http://blog.siphos.be/tag/grsecurity/">grsecurity</a>
        /
	<a href="http://blog.siphos.be/tag/kernexec/">kernexec</a>
        /
	<a href="http://blog.siphos.be/tag/linux/">linux</a>
        /
	<a href="http://blog.siphos.be/tag/pax/">pax</a>
        /
	<a href="http://blog.siphos.be/tag/perf/">perf</a>
        /
	<a href="http://blog.siphos.be/tag/selinux/">selinux</a>
        /
	<a href="http://blog.siphos.be/tag/uderef/">uderef</a>
        /
	<a href="http://blog.siphos.be/tag/vulnerability/">vulnerability</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>There has been a few posts already on the local Linux kernel privilege
escalation, which has received the
<a href="https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2013-2094">CVE-2013-2094</a>
ID.
<a href="http://arstechnica.com/security/2013/05/critical-linux-vulnerability-imperils-users-even-after-silent-fix/">arstechnica</a>
has a write-up with links to good resources on the Internet, but I
definitely want to point readers to the
<a href="http://www.reddit.com/r/netsec/comments/1eb9iw/sdfucksheeporgs_semtexc_local_linux_root_exploit/c9ykrck">explanation</a>
that Brad Spengler made on the vulnerability.</p>
<p>In short, the vulnerability is an <em>out-of-bound</em> access to an array
within the Linux perf code (which is a performance measuring subsystem
enabled when <code>CONFIG_PERF_EVENTS</code> is enabled). This subsystem is often
enabled as it offers a wide range of performance measurement techniques
(see <a href="https://perf.wiki.kernel.org/index.php/Main_Page">its wiki</a> for
more information). You can check on your own system through the kernel
configuration (<strong>zgrep CONFIG_PERF_EVENTS /proc/config.gz</strong> if you
have the latter pseudo-file available - it is made available through
<code>CONFIG_IKCONFIG_PROC</code>).</p>
<p>The public exploit maps memory in userland, fills it with known data,
then triggers an out-of-bound decrement that tricks the kernel into
decrementing this data (mapped in userland). By looking at where the
decrement occurred, the exploit now knows the base address of the array.
Next, it targets (through the same vulnerability) the IDT base
(Interrupt Descriptor Table) and targets the overflow interrupt vector.
It increments the top part of the address that the vector points to
(which is 0xffffffff, becoming 0x00000000 thus pointing to the
userland), maps this memory region itself with shellcode, and then
triggers the overflow. The shell code used in the public exploit
modifies the credentials of the current task, sets uid/gid with root and
gives full capabilities, and then executes a shell.</p>
<p>As Brad mentions, <a href="https://grsecurity.net/~spender/uderef.txt">UDEREF</a>
(an option in a grSecurity enabled kernel) should mitigate the attempt
to get to the userland. On my system, the exploit fails with the
following (start of) oops (without affecting the system further) when it
tries to close the file descriptor returned from the syscall that
invokes the decrement:</p>
<div class="highlight"><pre><span></span><code>[ 1926.226678] PAX: please report this to pageexec@freemail.hu
[ 1926.227019] BUG: unable to handle kernel paging request at 0000000381f5815c
[ 1926.227019] IP: [] sw_perf_event_destroy+0x1a/0xa0
[ 1926.227019] PGD 58a7c000 
[ 1926.227019] Thread overran stack, or stack corrupted
[ 1926.227019] Oops: 0002 [#4] PREEMPT SMP 
[ 1926.227019] Modules linked in: libcrc32c
[ 1926.227019] CPU 0 
[ 1926.227019] Pid: 4267, comm: test Tainted: G      D      3.8.7-hardened #1 Bochs Bochs
[ 1926.227019] RIP: 0010:[]  [] sw_perf_event_destroy+0x1a/0xa0
[ 1926.227019] RSP: 0018:ffff880058a03e08  EFLAGS: 00010246
...
</code></pre></div>


<p>The exploit also finds that the decrement didn't succeed:</p>
<div class="highlight"><pre><span></span><code>test: semtex.c:76: main: Assertion &#39;i&lt;0x0100000000/4&#39; failed.
</code></pre></div>


<p>A second mitigation is that
<a href="http://pax.grsecurity.net/docs/PaXTeam-H2HC12-PaX-kernel-self-protection.pdf">KERNEXEC</a>
(also offered through grSecurity) which prevents the kernel from
executing data that is writable (including userland data). So modifying
the IDT would be mitigated as well.</p>
<p>Another important mitigation is TPE - <em>Trusted Path Execution</em>. This
feature prevents the execution of binaries that are not located in a
root-owned directory and owned by a trusted group (which on my system is
10 = wheel). So users attempting to execute such code will fail with a
<em>Permission denied</em> error, and the following is shown in the logs:</p>
<div class="highlight"><pre><span></span><code>[ 3152.165780] grsec: denied untrusted exec (due to not being in trusted group and file in non-root-owned directory) of /home/user/test by /home/user/test[bash:4382] uid/euid:1000/1000 gid/egid:100/100, parent /bin/bash[bash:4352] uid/euid:1000/1000 gid/egid:100/100
</code></pre></div>


<p>However, even though a nicely hardened system should be fairly immune
against the currently circling public exploit, it should be noted that
it is not immune against the vulnerability itself. The methods above
mentioned make it so that that particular way of gaining root access is
not possible, but it still allows an attacker to decrement and increment
memory in specific locations so other exploits might be found to modify
the system.</p>
<p>Now out-of-bound vulnerabilities are not new. Recently (february this
year), a
<a href="http://www.phoronix.com/scan.php?page=news_item&amp;px=MTMxMTg">vulnerability</a>
in the networking code also provided an attack vector to get a local
privilege escalation. A mandatory access control system like SELinux has
little impact on such vulnerabilities if you allow users to execute
their own code. Even confined users can modify the exploit to disable
SELinux (since the shell code is ran with ring0 privileges it can access
and modify the SELinux state information in the kernel).</p>
<p>Many thanks to Brad for the excellent write-up, and to the <a href="http://www.gentoo.org/proj/en/hardened">Gentoo
Hardened</a> team for providing the
grSecurity PaX/TPE protections in its <code>hardened-sources</code> kernel.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'looking-at-the-local-linux-kernel-privilege-escalation';
                var disqus_url = 'http://blog.siphos.be/2013/05/looking-at-the-local-linux-kernel-privilege-escalation/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>