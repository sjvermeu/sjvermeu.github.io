<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>A SELinux policy for incron: our first interface - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.siphos.be/2013/05/a-selinux-policy-for-incron-our-first-interface/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="incron,interface,policy" />
        <meta name="description" content="The next step after having a basic skeleton is to get incrontab running. We know however that everything invoked from the main daemon will be running with the rights of the daemon context (unless we would patch the source code, but that is beyond the scope of this set of …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="A SELinux policy for incron: our first interface"/>
        <meta property="og:url" content="http://blog.siphos.be/2013/05/a-selinux-policy-for-incron-our-first-interface/"/>
        <meta property="og:description" content="The next step after having a basic skeleton is to get incrontab running. We know however that everything invoked from the main daemon will be running with the rights of the daemon context (unless we would patch the source code, but that is beyond the scope of this set of …"/>
        <meta property="article:published_time" content="2013-05-24" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:tag" content="incron" />
            <meta property="article:tag" content="interface" />
            <meta property="article:tag" content="policy" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="http://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="http://blog.siphos.be/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>



        <link href="http://blog.siphos.be/feeds/selinux.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="http://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.siphos.be/2013/05/a-selinux-policy-for-incron-our-first-interface/"
                       rel="bookmark"
                       title="Permalink to A SELinux policy for incron: our first interface">
                        A SELinux policy for incron: our first interface
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-05-24T03:50:00+02:00"> Fri 24 May 2013</time>
    </span>


            <span class="label label-default">By</span>
            <a href="http://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="http://blog.siphos.be/category/selinux.html">SELinux</a>


<span class="label label-default">Tags</span>
	<a href="http://blog.siphos.be/tag/incron/">incron</a>
        /
	<a href="http://blog.siphos.be/tag/interface/">interface</a>
        /
	<a href="http://blog.siphos.be/tag/policy/">policy</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>The next step after having <a href="http://blog.siphos.be/2013/05/a-selinux-policy-for-incron-the-basic-skeleton/">a basic
skeleton</a>
is to get <strong>incrontab</strong> running. We know however that everything invoked
from the main daemon will be running with the rights of the daemon
context (unless we would patch the source code, but that is beyond the
scope of this set of posts). As a result, we probably do not want
everyone to be able to launch commands through this application.</p>
<p>What we want to do is to limit who can invoke <strong>incrontab</strong> and, as
such, limit who can decide what is invoked through <strong>incrond</strong>. First of
all, we define a <em>role attribute</em> called <code>incrontab_roles</code>. Every role
that gets this attribute assigned will be able to transition to the
<code>incrontab_t</code> domain.</p>
<p>We can accomplish this by editing the <code>incron.te</code> file:</p>
<div class="highlight"><pre><span></span><code>policy_module(incron, 0.2)

# Declare the incrontab_roles attribute
attribute_role incrontab_roles;

...
type incrontab_t;
type incrontab_exec_t;
application_domain(incrontab_t, incrontab_exec_t)
# Allow incrontab_t for all incrontab_roles 
role incrontab_roles types incrontab_t;
</code></pre></div>


<p>Next, we need something where we can allow user domains to call
incrontab. This will be done through an interface. Let's look at
<code>incron.if</code> with one such interface in it: the <em>incron_role</em> interface.</p>
<div class="highlight"><pre><span></span><code>## inotify-based cron-like daemon

#########################################
## &lt;summary&gt;
##      Role access for incrontab
## &lt;/summary&gt;
## &lt;param name=&quot;role&quot;&gt;
##      &lt;summary&gt;
##      Role allowed access.
##      &lt;/summary&gt;
## &lt;/param&gt;
## &lt;param name=&quot;domain&quot;&gt;
##      &lt;summary&gt;
##      User domain for the role.
##      &lt;/summary&gt;
## &lt;/param&gt;
#
interface(`incron_role&#39;,`
        gen_require(`
                attribute_role incrontab_roles;
                type incrontab_exec_t, incrontab_t;
        &#39;)

        roleattribute $1 incrontab_roles;

        domtrans_pattern($2, incrontab_exec_t, incrontab_t)

        ps_process_pattern($2, incrontab_t)
        allow $2 incrontab_t:process signal;
&#39;)
</code></pre></div>


<p>The comments in the file are somewhat special: if the comments start
with two hashes (<code>##</code>) then it is taken into account while building the
policy documentation in <code>/usr/share/doc/selinux-base-*</code>. The interface
itself, <em>incron_role</em>, grants a user role and domain the necessary
privileges to transition to the <code>incrontab_t</code> domain as well as read
process information (as used through <strong>ps</strong>, hence the name of the
pattern being <code>ps_process_pattern</code>) and send a standard signal to it.
Most of the time, you can use <code>signal_perms</code> here but from looking at
the application we see that the application is setuid root, so we don't
want to grant too many privileges by default if they are not needed.</p>
<p>With this interface file created, we can rebuild the module and load it.</p>
<div class="highlight"><pre><span></span><code># make -f /usr/share/selinux/strict/include/Makefile incron.pp
# semodule -i incron.pp
</code></pre></div>


<p>But how to assign this interface to users? Well, what we want to do is
something like the following:</p>
<div class="highlight"><pre><span></span><code>incron_role(user_r, user_t)
</code></pre></div>


<p>When interfaces are part of the policy provided by the distribution, the
definitions of it are stored in the proper location and you can easily
add it. For instance, in Gentoo, if you want to allow the <code>user_r</code> role
and <code>user_t</code> domain the <em>cron_role</em> access (and assuming it doesn't
have so already), then you can call <strong>selocal</strong> as follows:</p>
<div class="highlight"><pre><span></span><code># selocal -a &quot;cron_role(user_r, user_t)&quot; -c &quot;Granting user_t cron access&quot; -Lb
</code></pre></div>


<p>However, because the interface is currently not known yet, we need to
create a second small policy that does this. Create a file (called
<code>localuser.te</code> or so) with the following content:</p>
<div class="highlight"><pre><span></span><code>policy_module(localuser, 0.1)

gen_require(`
        type user_t;
        role user_r;
&#39;)

incron_role(user_r, user_t)
</code></pre></div>


<p>Now build the policies and load them. We'll now just build and load all
the policies in the current directory (which will be the incron and
localuser ones):</p>
<div class="highlight"><pre><span></span><code># make -f /usr/share/selinux/strict/include/Makefile
# semodule -i *.pp
</code></pre></div>


<p>You can now verify that the user is allowed to transition to the
<code>incrontab_t</code> domain:</p>
<div class="highlight"><pre><span></span><code># seinfo -ruser_r -x | grep incron
         incrontab_t
# sesearch -s user_t -t incrontab_exec_t -AdCTS
Found 1 semantic av rules:
   allow user_t incrontab_exec_t : file { read getattr execute open } ;

Found 1 semantic te rules:
   type_transition user_t incrontab_exec_t : process incrontab_t;
</code></pre></div>


<p>Great, let's get to our first failure to resolve... in the next post ;-)</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'a-selinux-policy-for-incron-our-first-interface';
                var disqus_url = 'http://blog.siphos.be/2013/05/a-selinux-policy-for-incron-our-first-interface/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>