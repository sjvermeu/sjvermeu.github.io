<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>SELinux and noatsecure, or why portage complains about LD_PRELOAD and libsandbox.so - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2011/04/selinux-and-noatsecure-or-why-portage-complains-about-ld_preload-and-libsandbox-so/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="description" content="If you&#39;re fiddling with SELinux policies, you will eventually notice that the reference policy by default hides certain privilege requests (which are denied). One of them is noatsecure. But what is noatsecure? To describe noatsecure, I first need to describe what atsecure is. And to describe what that is, we …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="SELinux and noatsecure, or why portage complains about LD_PRELOAD and libsandbox.so"/>
        <meta property="og:url" content="https://blog.siphos.be/2011/04/selinux-and-noatsecure-or-why-portage-complains-about-ld_preload-and-libsandbox-so/"/>
        <meta property="og:description" content="If you&#39;re fiddling with SELinux policies, you will eventually notice that the reference policy by default hides certain privilege requests (which are denied). One of them is noatsecure. But what is noatsecure? To describe noatsecure, I first need to describe what atsecure is. And to describe what that is, we …"/>
        <meta property="article:published_time" content="2011-04-22" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/selinux/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2011/04/selinux-and-noatsecure-or-why-portage-complains-about-ld_preload-and-libsandbox-so/"
                       rel="bookmark"
                       title="Permalink to SELinux and noatsecure, or why portage complains about LD_PRELOAD and libsandbox.so">
                        SELinux and noatsecure, or why portage complains about LD_PRELOAD and libsandbox.so
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2011-04-22T21:00:00+02:00"> Fri 22 April 2011</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/selinux.html">SELinux</a>


    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>If you're fiddling with SELinux policies, you will eventually notice
that the reference policy by default hides certain privilege requests
(which are denied). One of them is noatsecure. But what is noatsecure?
To describe noatsecure, I first need to describe what atsecure is. And
to describe what that is, we first need to give a small talk about ELF
auxiliary vectors.</p>
<p>As you probably know, when an application instantiates another
application, it calls the <code>execve</code> function right after fork'ing to load
the new application in memory. The actual task to load the new
application in memory is done by the C library, more specifically the
binary loader. For Linux, this is the ELF loader. Now, <em>ELF auxiliary
vectors</em> are parameters or flags that are set (or at least managed) by
the ELF loader to allow the application and program interpreter to get
some OS-specific information. Examples of such vectors are <code>AT_UID</code> and
<code>AT_EUID</code> (real uid and effective uid) and <code>AT_PAGESZ</code> (system page
size).</p>
<p>One of the vectors that glibc supports is <code>AT_SECURE</code>. This particular
parameter (which is either "0" (default) or "1") tells the ELF dynamic
linker to unset various <a href="http://sourceware.org/git/?p=glibc.git;a=blob_plain;f=sysdeps/generic/unsecvars.h;hb=HEAD">environment
variables</a>
that are considered potentially harmful for your system. One of these is
<code>LD_PRELOAD</code> (I mention this one specifically because it was the source
of my small investigation). Normally, this environment sanitation is
done when a setuid/setgid application is called (to prevent the obvious
vulnerabilities). However, SELinux enhances the use of this
sanitation...</p>
<p>Whenever an application is called which triggers a domain transition in
SELinux (say <code>sysadm_t</code> to <code>mozilla_t</code> through a binary labelled
<code>mozilla_exec_t</code>), SELinux sets the <code>AT_SECURE</code> flag for the loaded
application (in the example, mozilla/firefox). In other words, every
time a domain transition occurs, the environment for this application is
sanitized.</p>
<p>As you can imagine now the <code>noatsecure</code> permission disables the
environment sanitation activity for a particular transition. You can do
this through the following allow statement (applied to the above
example):</p>
<div class="highlight"><pre><span></span><code>allow sysadm_t mozilla_t:process { noatsecure };
</code></pre></div>


<p>if every domain transition for which this permission isn't allowed would
log its denial, our audit logs would be filled with noise. That is why
the reference policy by default hides (<code>dontaudit</code>) these calls. But
knowing what they are for is important, because you might sometimes come
into contact with it, like I did:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; Installing (1 of 1) net-dns/host-991529
&gt;&gt;&gt; Setting SELinux security labels
ERROR: ld.so: object &#39;libsandbox.so&#39; from LD_PRELOAD cannot be preloaded: ignored.
</code></pre></div>


<p>This error message is when Portage (running in <code>portage_t</code>) wants to
relabel the files that it just placed on the system through setfiles
(which will run in <code>setfiles_t</code>). As this involves a domain transition,
<code>AT_SECURE</code> is set for setfiles, but <code>LD_PRELOAD</code> was set as part of
Portage' sandboxing feature. This environment variable is disabled, and
the loader warns the user that it cannot preload <code>libsandbox.so</code>.</p>
<p>Although we can just set <em>noatsecure</em> here, it would open up a (small)
window for exploits (although they would need to be provided through
Portage, because when a user calls Portage, a domain transition is done
there as well so the user-provided environment variables are already
sanitized by then). By not allowing <em>noatsecure</em>, we are disabling a few
functionalities provided by the libsandbox.so library <em>for the file
labeling activity</em> (this is <strong>very important</strong> to understand: it does
not disable the sandboxing for the builds and merges, only for the file
relabeling). As we already run setfiles in its own, confined domain, I
believe that we are best served by keeping the secure environment
sanitation here. That does mean that the warning will stay as we cannot
control that from within SELinux.</p>
<p>If you want to allow <em>noatsecure</em> here, create a simple module and load
it:</p>
<div class="highlight"><pre><span></span><code>~# cat &gt; portage_noatsecure.te &lt;&lt; EOF
module portage_noatsecure 1.0;
require {
  type portage_t;
  type setfiles_t;
  class process { noatsecure };
}
allow portage_t setfiles_t:process { noatsecure };
EOF
~# checkmodule -m -o portage_noatsecure.mod portage_noatsecure.te
~# semodule_package -o portage_noatsecure.pp -m portage_noatsecure.mod
~# semodule -i portage_noatsecure.pp
</code></pre></div>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'selinux-and-noatsecure-or-why-portage-complains-about-ld_preload-and-libsandbox-so';
                var disqus_url = 'https://blog.siphos.be/2011/04/selinux-and-noatsecure-or-why-portage-complains-about-ld_preload-and-libsandbox-so/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>