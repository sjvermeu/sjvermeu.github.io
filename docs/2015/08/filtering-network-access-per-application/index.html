<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Filtering network access per application - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2015/08/filtering-network-access-per-application/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="selinux,network,iptables" />
        <meta name="description" content="Iptables (and the successor nftables) is a powerful packet filtering system in the Linux kernel, able to create advanced firewall capabilities. One of the features that it cannot provide is per-application filtering. Together with SELinux however, it is possible to implement this on a per domain basis. SELinux does not …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Filtering network access per application"/>
        <meta property="og:url" content="https://blog.siphos.be/2015/08/filtering-network-access-per-application/"/>
        <meta property="og:description" content="Iptables (and the successor nftables) is a powerful packet filtering system in the Linux kernel, able to create advanced firewall capabilities. One of the features that it cannot provide is per-application filtering. Together with SELinux however, it is possible to implement this on a per domain basis. SELinux does not …"/>
        <meta property="article:published_time" content="2015-08-07" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:tag" content="network" />
            <meta property="article:tag" content="iptables" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/selinux/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2015/08/filtering-network-access-per-application/"
                       rel="bookmark"
                       title="Permalink to Filtering network access per application">
                        Filtering network access per application
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-08-07T03:49:00+02:00"> Fri 07 August 2015</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/selinux.html">SELinux</a>


<span class="label label-default">Tags</span>
	<a href="https://blog.siphos.be/tag/selinux/">selinux</a>
        /
	<a href="https://blog.siphos.be/tag/network/">network</a>
        /
	<a href="https://blog.siphos.be/tag/iptables/">iptables</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Iptables (and the successor nftables) is a powerful packet filtering system in
the Linux kernel, able to create advanced firewall capabilities. One of the 
features that it <em>cannot</em> provide is per-application filtering. Together with
SELinux however, it is possible to implement this on a <em>per domain</em> basis.</p>
<p>SELinux does not know applications, but it knows domains. If we ensure that each
application runs in its own domain, then we can leverage the firewall
capabilities with SELinux to only allow those domains access that we need.</p>


<p><strong>SELinux network control: packet types</strong></p>
<p>The basic network control we need to enable is SELinux' packet types. Most
default policies will grant application domains the right set of packet types:</p>
<div class="highlight"><pre><span></span><code>~# sesearch -s mozilla_t -c packet -A
Found 13 semantic av rules:
   allow mozilla_t ipp_client_packet_t : packet { send recv } ; 
   allow mozilla_t soundd_client_packet_t : packet { send recv } ; 
   allow nsswitch_domain dns_client_packet_t : packet { send recv } ; 
   allow mozilla_t speech_client_packet_t : packet { send recv } ; 
   allow mozilla_t ftp_client_packet_t : packet { send recv } ; 
   allow mozilla_t http_client_packet_t : packet { send recv } ; 
   allow mozilla_t tor_client_packet_t : packet { send recv } ; 
   allow mozilla_t squid_client_packet_t : packet { send recv } ; 
   allow mozilla_t http_cache_client_packet_t : packet { send recv } ; 
 DT allow mozilla_t server_packet_type : packet recv ; [ mozilla_bind_all_unreserved_ports ]
 DT allow mozilla_t server_packet_type : packet send ; [ mozilla_bind_all_unreserved_ports ]
 DT allow nsswitch_domain ldap_client_packet_t : packet recv ; [ authlogin_nsswitch_use_ldap ]
 DT allow nsswitch_domain ldap_client_packet_t : packet send ; [ authlogin_nsswitch_use_ldap ]
</code></pre></div>


<p>As we can see, the <code>mozilla_t</code> domain is able to send and receive packets of
type <code>ipp_client_packet_t</code>, <code>soundd_client_packet_t</code>, <code>dns_client_packet_t</code>, 
<code>speech_client_packet_t</code>, <code>ftp_client_packet_t</code>, <code>http_client_packet_t</code>, 
<code>tor_client_packet_t</code>, <code>squid_client_packet_t</code> and <code>http_cache_client_packet_t</code>.
If the SELinux booleans mentioned at the end are enabled, additional packet
types are alloed to be used as well.</p>
<p>But even with this default policy in place, SELinux is not being consulted for
filtering. To accomplish this, <code>iptables</code> will need to be told to label the
incoming and outgoing packets. This is the <a href="http://blog.siphos.be/2013/05/secmark-and-selinux/">SECMARK</a>
functionality that I've blogged about earlier.</p>
<p><strong>Enabling SECMARK filtering through iptables</strong></p>
<p>To enable SECMARK filtering, we use the <code>iptables</code> command and tell it to label
SSH incoming and outgoing packets as <code>ssh_server_packet_t</code>:</p>
<div class="highlight"><pre><span></span><code>~# iptables -t mangle -A INPUT -m state --state ESTABLISHED,RELATED -j CONNSECMARK --restore
~# iptables -t mangle -A INPUT -p tcp --dport 22 -j SECMARK --selctx system_u:object_r:ssh_server_packet_t:s0
~# iptables -t mangle -A OUTPUT -m state --state ESTABLISHED,RELATED -j CONNSECMARK --restore
~# iptables -t mangle -A OUTPUT -p tcp --sport 22 -j SECMARK --selctx system_u:object_r:ssh_server_packet_t:s0
</code></pre></div>


<p>But be warned: the moment iptables starts with its SECMARK support, <em>all packets</em>
will be labeled. Those that are not explicitly labeled through one of the above
commands will be labeled with the <code>unlabeled_t</code> type, and most domains are not
allowed any access to <code>unlabeled_t</code>.</p>
<p>There are two things we can do to improve this situation:</p>
<ol>
<li>Define the necessary SECMARK rules for all supported ports (which is something
   that <a href="https://www.linux.com/learn/tutorials/421152:using-selinux-and-iptables-together">secmarkgen</a>
   does), and/or</li>
<li>Allow <code>unlabeled_t</code> for all domains.</li>
</ol>
<p>To allow the latter, we can load a SELinux rule like the following:</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="nv">allow</span> <span class="nv">domain</span> <span class="nv">unlabeled_t</span> <span class="p">(</span><span class="nv">packet</span> <span class="p">(</span><span class="nv">send</span> <span class="nv">recv</span><span class="p">)))</span>
</code></pre></div>


<p>This will allow all domains to send and receive packets of the <code>unlabeled_t</code> type.
Although this is something that might be security-sensitive, it might be a good idea
to allow at start, together with proper auditing (you can use <code>(auditallow ...)</code> to
audit all granted packet communication) so that the right set of packet types can be
enabled. This way, administrators can iteratively improve the SECMARK rules and finally
remove the <code>unlabeled_t</code> privilege from the <code>domain</code> attribute.</p>
<p>To list the current SECMARK rules, list the firewall rules for the <code>mangle</code> table:</p>
<div class="highlight"><pre><span></span><code>~# iptables -t mangle -nvL
</code></pre></div>


<p><strong>Only granting one application network access</strong></p>
<p>These two together allow for creating a firewall that only allows a single domain
access to a particular target.</p>
<p>For instance, suppose that we only want the <code>mozilla_t</code> domain to connect to the
company proxy (10.15.10.5). We can't enable the <code>http_client_packet_t</code> for this
connection, as all other web browsers and other HTTP-aware applications will have
policy rules enabled to send and receive that packet type. Instead, we are going
to create a new packet type to use.</p>
<div class="highlight"><pre><span></span><code><span class="c1">;; Definition of myhttp_client_packet_t</span>
<span class="p">(</span><span class="k">type</span> <span class="nv">myhttp_client_packet_t</span><span class="p">)</span>
<span class="p">(</span><span class="nv">roletype</span> <span class="nv">object_r</span> <span class="nv">myhttp_client_packet_t</span><span class="p">)</span>
<span class="p">(</span><span class="nv">typeattributeset</span> <span class="nv">client_packet_type</span> <span class="p">(</span><span class="nv">myhttp_client_packet_t</span><span class="p">))</span>
<span class="p">(</span><span class="nv">typeattributeset</span> <span class="nv">packet_type</span> <span class="p">(</span><span class="nv">myhttp_client_packet_t</span><span class="p">))</span>

<span class="c1">;; Grant the use to mozilla_t</span>
<span class="p">(</span><span class="nv">typeattributeset</span> <span class="nv">cil_gen_require</span> <span class="nv">mozilla_t</span><span class="p">)</span>
<span class="p">(</span><span class="nv">allow</span> <span class="nv">mozilla_t</span> <span class="nv">myhttp_client_packet_t</span> <span class="p">(</span><span class="nv">packet</span> <span class="p">(</span><span class="nv">send</span> <span class="nv">recv</span><span class="p">)))</span>
</code></pre></div>


<p>Putting the above in a <code>myhttppacket.cil</code> file and loading it allows the type
to be used:</p>
<div class="highlight"><pre><span></span><code>~# semodule -i myhttppacket.cil
</code></pre></div>


<p>Now, the <code>myhttp_client_packet_t</code> type can be used in <code>iptables</code> rules. Also, 
only the <code>mozilla_t</code> domain is allowed to send and receive these packets,
effectively creating an application-based firewall, as all we now need to do
is to mark the outgoing packets towards the proxy as <code>myhttp_client_packet_t</code>:</p>
<div class="highlight"><pre><span></span><code>~# iptables -t mangle -A OUTPUT -p tcp --dport 80 -d 10.15.10.5 -j SECMARK --selctx system_u:object_r:myhttp_client_packet_t:s0
</code></pre></div>


<p>This shows that it is <em>possible</em> to create such firewall rules with SELinux. It
is however not an out-of-the-box solution, requiring thought and development of
both firewall rules and SELinux code constructions. Still, with some advanced
scripting experience this will lead to a powerful addition to a hardened
system.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'filtering-network-access-per-application';
                var disqus_url = 'https://blog.siphos.be/2015/08/filtering-network-access-per-application/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>