<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Restricting even root access to a folder - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2015/07/restricting-even-root-access-to-a-folder/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="description" content="In a comment Robert asked how to use SELinux to prevent even root access to a directory. The trivial solution would be not to assign an administrative role to the root account (which is definitely possible, but you want some way to gain administrative access otherwise ;-) Restricting root is one of the commonly referred features of a MAC (Mandatory Access Control) system. With a well designed user management and sudo environment, it is fairly trivial - but if you need to start from the premise that a user has direct root access, it requires some thought to implement it correctly. The main &#34;issue&#34; is not that it is difficult to implement policy-wise, but that most users will start from a pre-existing policy (such as the reference policy) and build on top of that." />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Restricting even root access to a folder"/>
        <meta property="og:url" content="https://blog.siphos.be/2015/07/restricting-even-root-access-to-a-folder/"/>
        <meta property="og:description" content="In a comment Robert asked how to use SELinux to prevent even root access to a directory. The trivial solution would be not to assign an administrative role to the root account (which is definitely possible, but you want some way to gain administrative access otherwise ;-) Restricting root is one of the commonly referred features of a MAC (Mandatory Access Control) system. With a well designed user management and sudo environment, it is fairly trivial - but if you need to start from the premise that a user has direct root access, it requires some thought to implement it correctly. The main &#34;issue&#34; is not that it is difficult to implement policy-wise, but that most users will start from a pre-existing policy (such as the reference policy) and build on top of that."/>
        <meta property="article:published_time" content="2015-07-11" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/selinux/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2015/07/restricting-even-root-access-to-a-folder/"
                       rel="bookmark"
                       title="Permalink to Restricting even root access to a folder">
                        Restricting even root access to a folder
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-07-11T14:09:00+02:00"> Sat 11 July 2015</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/selinux.html">SELinux</a>


    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>In a
<a href="http://blog.siphos.be/2014/01/private-key-handling-and-selinux-protection/comment-page-1/#comment-143323">comment</a>
Robert asked how to use SELinux to prevent even root access to a
directory. The trivial solution would be not to assign an administrative
role to the root account (which is definitely possible, but you want
some way to gain administrative access otherwise ;-)</p>
<p>Restricting root is one of the commonly referred features of a MAC
(Mandatory Access Control) system. With a well designed user management
and sudo environment, it is fairly trivial - but if you need to start
from the premise that a user has direct root access, it requires some
thought to implement it correctly. The main "issue" is not that it is
difficult to implement policy-wise, but that most users will start from
a pre-existing policy (such as the reference policy) and build on top of
that.</p>


<p>The use of a pre-existing policy means that some roles are already
identified and privileges are already granted to users - often these
higher privileged roles are assigned to the Linux root user as not to
confuse users. But that does mean that restricting root access to a
folder means that some additional countermeasures need to be
implemented.</p>
<p><strong>The policy</strong></p>
<p>But first things first. Let's look at a simple policy for restricting
access to <code>/etc/private</code>:</p>
<div class="highlight"><pre><span></span><code>policy_module(myprivate, 1.0)

type etc_private_t;
fs_associate(etc_private_t)
</code></pre></div>

<p>This simple policy introduces a type (<code>etc_private_t</code>) which is allowed
to be used for files (it associates with a file system). <em>Do not</em> use
the <code>files_type()</code> interface as this would assign a set of attributes
that many user roles get read access on.</p>
<p>Now, it is not sufficient to have the type available. If we want to
assign it to a type, someone or something needs to have the privileges
to change the security context of a file and directory to this type. If
we would just load this policy and try to do this from a privileged
account, it would fail:</p>
<div class="highlight"><pre><span></span><code>~# chcon -t etc_private_t /etc/private
chcon: failed to change context of &#39;/etc/private&#39; to &#39;system_u:object_r:etc_private_t:s0&#39;: Permission denied
</code></pre></div>

<p>With the following rule, the <code>sysadm_t</code> domain (which I use for system
administration) is allowed to change the context to <code>etc_private_t</code>:</p>
<div class="highlight"><pre><span></span><code>allow sysadm_t etc_private_t:{dir file} relabelto;
</code></pre></div>

<p>With this in place, the administrator can label resources as
<code>etc_private_t</code> without having read access to these resources
afterwards. Also, as long as there are no <em>relabelfrom</em> privileges
assigned, the administrator cannot revert the context back to a type
that he has read access to.</p>
<p><strong>The countermeasures</strong></p>
<p>But this policy is not sufficient. One way that administrators can
easily access the resources is to disable SELinux controls (as in, put
the system in permissive mode):</p>
<div class="highlight"><pre><span></span><code>~# cat /etc/private/README
cat: /etc/private/README: Permission denied
~# setenforce 0
~# cat /etc/private/README
Hello World!
</code></pre></div>

<p>To prevent this, enable the <em>secure_mode_policyload</em> SELinux boolean:</p>
<div class="highlight"><pre><span></span><code>~# setsebool secure_mode_policyload on
</code></pre></div>

<p>This will prevent any policy and SELinux state manipulation... including
permissive mode, but also including loading additional SELinux policies
or changing booleans. Definitely experiment with this setting without
persisting (i.e. do not use <code>-P</code> in the above command yet) to make sure
it is manageable for you.</p>
<p>Still, this isn't sufficient. Don't forget that the administrator is
otherwise a full administrator - if he cannot access the <code>/etc/private</code>
location directly, then he might be able to access it indirectly:</p>
<ul>
<li>If the resource is on a non-critical file system, he can unmount the
    file system and remount it with a <code>context=</code> mount option. This will
    override the file-level contexts. Bind-mounting does not seem to
    allow overriding the context.</li>
<li>If the resource is on a file system that cannot be unmounted, the
    administrator can still reboot the system in a mode where he can
    access the file system regardless of SELinux controls (either
    through editing <code>/etc/selinux/config</code> or by booting with
    <code>enforcing=0</code>, etc.</li>
<li>The administrator can still access the block device files on which
    the resources are directly. Specialized tools can allow for
    extracting files and directories without actually (re)mounting
    the device.</li>
</ul>
<p>A more extensive list of methods to potentially gain access to such
resources is iterated in <a href="http://blog.siphos.be/2013/12/limiting-file-access-with-selinux-alone/">Limiting file access with SELinux
alone</a>.</p>
<p>This set of methods for gaining access is due to the administrative role
already assigned by the existing policy. To further mitigate these risks
with SELinux (although SELinux will never completely mitigate all risks)
the roles assigned to the users need to be carefully revisited. If you
grant people administrative access, but you don't want them to be able
to reboot the system, (re)mount file systems, access block devices, etc.
then create a user role that does not have these privileges at all.</p>
<p>Creating such user roles does not require leaving behind the policy that
is already active. Additional user domains can be created and granted to
Linux accounts (including root). But in my experience, when you need to
allow a user to log on as the "root" account directly, you probably need
him to have true administrative privileges. Otherwise you'd work with
personal accounts and a well-designed <code>/etc/sudoers</code> file.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'restricting-even-root-access-to-a-folder';
                var disqus_url = 'https://blog.siphos.be/2015/07/restricting-even-root-access-to-a-folder/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>