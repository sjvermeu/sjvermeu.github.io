<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Maintaining packages and backporting - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.siphos.be/2015/09/maintaining-packages-and-backporting/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="gentoo,ebuild,patching" />
        <meta name="description" content="A few days ago I committed a small update to policycoreutils, a SELinux related package that provides most of the management utilities for SELinux systems. The fix was to get two patches (which are committed upstream) into the existing release so that our users can benefit from the fixed issues …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Maintaining packages and backporting"/>
        <meta property="og:url" content="http://blog.siphos.be/2015/09/maintaining-packages-and-backporting/"/>
        <meta property="og:description" content="A few days ago I committed a small update to policycoreutils, a SELinux related package that provides most of the management utilities for SELinux systems. The fix was to get two patches (which are committed upstream) into the existing release so that our users can benefit from the fixed issues …"/>
        <meta property="article:published_time" content="2015-09-02" />
            <meta property="article:section" content="Gentoo" />
            <meta property="article:tag" content="gentoo" />
            <meta property="article:tag" content="ebuild" />
            <meta property="article:tag" content="patching" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="http://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="http://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="http://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="http://blog.siphos.be/category/gentoo/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... Gentoo ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="http://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.siphos.be/2015/09/maintaining-packages-and-backporting/"
                       rel="bookmark"
                       title="Permalink to Maintaining packages and backporting">
                        Maintaining packages and backporting
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-09-02T20:33:00+02:00"> Wed 02 September 2015</time>
    </span>


            <span class="label label-default">By</span>
            <a href="http://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="http://blog.siphos.be/category/gentoo.html">Gentoo</a>


<span class="label label-default">Tags</span>
	<a href="http://blog.siphos.be/tag/gentoo/">gentoo</a>
        /
	<a href="http://blog.siphos.be/tag/ebuild/">ebuild</a>
        /
	<a href="http://blog.siphos.be/tag/patching/">patching</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>A few days ago I committed a small update to <code>policycoreutils</code>, a SELinux related
package that provides most of the management utilities for SELinux systems. The
fix was to get two patches (which are committed upstream) into the existing
release so that our users can benefit from the fixed issues without having to
wait for a new release.</p>


<p><strong>Getting the patches</strong></p>
<p>To capture the patches, I used <code>git</code> together with the commit id:</p>
<div class="highlight"><pre><span></span><code><span class="go">~$ git format-patch -n -1 73b7ff41</span>
<span class="go">0001-Only-invoke-RPM-on-RPM-enabled-Linux-distributions.patch</span>
<span class="go">~$ git format-patch -n -1 4fbc6623</span>
<span class="go">0001-Set-self.sename-to-sename-after-calling-semanage_seu.patch</span>
</code></pre></div>


<p>The two generated patch files contain all information about the commit. Thanks
to the <code>epatch</code> support in the <code>eutils.eclass</code>, these patch files are
immediately usable within Gentoo's ebuilds.</p>
<p><strong>Updating the ebuilds</strong></p>
<p>The SELinux userspace ebuilds in Gentoo all have <a href="http://blog.siphos.be/2015/06/live-selinux-userspace-ebuilds/">live ebuilds</a>
available which are immediately usable for releases. The idea with those live
ebuilds is that we can simply copy them and commit in order to make a new release.</p>
<p>So, in case of the patch backporting, the necessary patch files are first moved
into the <code>files/</code> subdirectory of the package. Then, the live ebuild is updated
to use the new patches:</p>
<div class="highlight"><pre><span></span><code><span class="gu">@@ -88,6 +85,8 @@ src_prepare() {</span>
                epatch &quot;${FILESDIR}/0070-remove-symlink-attempt-fails-with-gentoo-sandbox-approach.patch&quot;
                epatch &quot;${FILESDIR}/0110-build-mcstrans-bug-472912.patch&quot;
                epatch &quot;${FILESDIR}/0120-build-failure-for-mcscolor-for-CONTEXT__CONTAINS.patch&quot;
<span class="gi">+               epatch &quot;${FILESDIR}/0130-Only-invoke-RPM-on-RPM-enabled-Linux-distributions-bug-534682.patch&quot;</span>
<span class="gi">+               epatch &quot;${FILESDIR}/0140-Set-self.sename-to-sename-after-calling-semanage-bug-557370.patch&quot;</span>
        fi

        # rlpkg is more useful than fixfiles
</code></pre></div>


<p>The patches themselves do not apply for the live ebuilds themselves (they are
ignored there) as we want the live ebuilds to be as close to the upstream
project as possible. But because the ebuilds are immediately usable for
releases, we add the necessary information there first.</p>
<p>Next, the new release is created:</p>
<div class="highlight"><pre><span></span><code><span class="go">~$ cp policycoreutils-9999.ebuild policycoreutils-2.4-r2.ebuild</span>
</code></pre></div>


<p><strong>Testing the changes</strong></p>
<p>The new release is then tested. I have a couple of scripts that I use
for automated testing. So first I update these scripts to also try out
the functionality that was failing before. On existing systems, these
tests should fail:</p>
<div class="highlight"><pre><span></span><code>Running task semanage (Various semanage related operations).
  ...
    Executing step &quot;perm_port_on   : Marking portage_t as a permissive domain                              &quot; -&gt; ok
    Executing step &quot;perm_port_off  : Removing permissive mark from portage_t                               &quot; -&gt; ok
    Executing step &quot;selogin_modify : Modifying a SELinux login definition                                  &quot; -&gt; failed
</code></pre></div>


<p>Then, on a test system where the new package has been installed, the same
testset is executed (together with all other tests) to validate if the problem
is fixed.</p>
<p><strong>Pushing out the new release</strong></p>
<p>Finally, with the fixes in and validated, the new release is pushed out (into
~arch first of course) and the bugs are marked as <code>RESOLVED:TEST-REQUEST</code>. Users
can confirm that it works (which would move it to <code>VERIFIED:TEST-REQUEST</code>) or
we stabilize it after the regular testing period is over (which moves it to
<code>RESOLVED:FIXED</code> or <code>VERIFIED:FIXED</code>).</p>
<p>I do still have to get used to Gentoo using git as its repository now. The
<a href="https://wiki.gentoo.org/wiki/Gentoo_git_workflow">workflow</a> to use is
documented though. Luckily, because I often get that the <code>git push</code> fails
(due to changes to the tree since my last pull). So I need to run <code>git
pull --rebase=preserve</code> followed by <code>repoman full</code> and then the push again
sufficiently quick after each other).</p>
<p>This simple flow is easy to get used to. Thanks to the existing foundation
for package maintenance (such as <code>epatch</code> for patching, live ebuilds that
can be immediately used for releases and the ability to just cherry pick
patches towards our repository) we can serve updates with just a few minutes
of work.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'maintaining-packages-and-backporting';
                var disqus_url = 'http://blog.siphos.be/2015/09/maintaining-packages-and-backporting/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>