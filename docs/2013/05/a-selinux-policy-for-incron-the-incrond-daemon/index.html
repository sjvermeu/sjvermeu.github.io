<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>A SELinux policy for incron: the incrond daemon - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2013/05/a-selinux-policy-for-incron-the-incrond-daemon/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="incrond,selinux" />
        <meta name="description" content="With incrontab_t (hopefully) complete, let&#39;s look at the incrond_t domain. As this domain will also be used to execute the user (and system) commands provided through the incrontabs, we need to consider how we are going to deal with this wide range of possible permissions that it might take. One …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="A SELinux policy for incron: the incrond daemon"/>
        <meta property="og:url" content="https://blog.siphos.be/2013/05/a-selinux-policy-for-incron-the-incrond-daemon/"/>
        <meta property="og:description" content="With incrontab_t (hopefully) complete, let&#39;s look at the incrond_t domain. As this domain will also be used to execute the user (and system) commands provided through the incrontabs, we need to consider how we are going to deal with this wide range of possible permissions that it might take. One …"/>
        <meta property="article:published_time" content="2013-05-27" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:tag" content="incrond" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/selinux/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2013/05/a-selinux-policy-for-incron-the-incrond-daemon/"
                       rel="bookmark"
                       title="Permalink to A SELinux policy for incron: the incrond daemon">
                        A SELinux policy for incron: the incrond daemon
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-05-27T03:50:00+02:00"> Mon 27 May 2013</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/selinux.html">SELinux</a>


<span class="label label-default">Tags</span>
	<a href="https://blog.siphos.be/tag/incrond/">incrond</a>
        /
	<a href="https://blog.siphos.be/tag/selinux/">selinux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>With <code>incrontab_t</code> (hopefully) complete, let's look at the <code>incrond_t</code>
domain. As this domain will also be used to execute the user (and
system) commands provided through the incrontabs, we need to consider
how we are going to deal with this wide range of possible permissions
that it might take. One would be to make <code>incrond_t</code> quite powerful, and
extend its privileges as we go further. But in my opinion, that's not a
good way to deal with it.</p>
<p>Another would be to support a small set of permissions, and introduce an
interface that other modules can use to create a transition when
<code>incrond_t</code> executes a script properly labeled for a transition. For
instance, a domain <code>foo_t</code> might have an executable type <code>foo_exec_t</code>.
Most modules support an interface similar to <em>foo_domtrans</em> (and
<em>foo_role</em> if roles are applicable as well), but that assumes that the
<em>incron</em> policy is modified every time a new target module is made
available (since we then need to add the proper <em>*_domtrans</em> rules to
the <em>incron</em> policy. Instead, we might want to make this something that
the <em>foo</em> SELinux module can decide.</p>
<p>It is that approach that we are going to take here. To do so, we will
create a new interface called <em>incron_entry</em>, taken a bit from the
<em>cron_system_entry</em> interface already in place for the regular <em>cron</em>
domain (the following comes in <code>incron.if</code>):</p>
<div class="highlight"><pre><span></span><code>## &lt;summary&gt;
##      Make the specified program domain
##      accessible from the incrond job.
## &lt;/summary&gt;
## &lt;param name=&quot;domain&quot;&gt;
##      &lt;summary&gt;
##      The type of the process to transition to
##      &lt;/summary&gt;
## &lt;/param&gt;
## &lt;param name=&quot;entrypoint&quot;&gt;
##      &lt;summary&gt;
##      The type of the file used as an entrypoint to this domain
##      &lt;/summary&gt;
## &lt;/param&gt;
#
interface(`incron_entry&#39;,`
        gen_require(`
                type incrond_t;
        &#39;)

        domtrans_pattern(incrond_t, $2, $1)
&#39;)
</code></pre></div>

<p>With this in place, the <em>foo</em> SELinux module can call
<em>incron_entry(foo_t, foo_exec_t)</em> so that, the moment <code>incrond_t</code>
executes a file with label <code>foo_exec_t</code>, the resulting process will run
in <code>foo_t</code>. I am going to <em>test</em> (and I stress that it is only for
<em>testing</em>) this by assigning <em>incron_entry(system_cronjob_t,
shell_exec_t)</em>, making every shell script being called run in
<code>system_cronjob_t</code> domain (for instance in the <code>localuser.te</code> file that
already assigned <em>incron_role</em> to the <code>user_t</code> domain.</p>
<p>With that in place, it's time to start our iterations again.</p>
<div class="highlight"><pre><span></span><code># run_init rc-service incrond start
* start-stop-daemon: failed to start &#39;/usr/sbin/incrond&#39; [ !! ]
* ERROR: incrond failed to start

# tail audit.log
type=AVC msg=audit(1368732494.275:28319): avc:  denied  { read } for  pid=9282 comm=&quot;incrond&quot; name=&quot;localtime&quot; dev=&quot;dm-2&quot; ino=393663 scontext=system_u:system_r:incrond_t tcontext=system_u:object_r:locale_t tclass=file
type=AVC msg=audit(1368732494.275:28320): avc:  denied  { create } for  pid=9282 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
type=AVC msg=audit(1368732494.276:28321): avc:  denied  { read } for  pid=9282 comm=&quot;incrond&quot; name=&quot;incron.d&quot; dev=&quot;dm-2&quot; ino=394140 scontext=system_u:system_r:incrond_t tcontext=root:object_r:incron_spool_t tclass=dir
type=AVC msg=audit(1368732494.276:28322): avc:  denied  { create } for  pid=9282 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
type=AVC msg=audit(1368732494.276:28323): avc:  denied  { create } for  pid=9282 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
</code></pre></div>

<p>Ignoring the <em>unix_dgram_socket</em> for now, we need to allow <code>incrond_t</code>
to read locale information, and to read the files in the
<code>/var/spool/incron</code> location (this goes in <code>incron.te</code> again):</p>
<div class="highlight"><pre><span></span><code>###########################################
#
# incrond policy
#

read_files_pattern(incrond_t, incron_spool_t, incron_spool_t)

files_search_spool(incrond_t)

miscfiles_read_localization(incrond_t)
</code></pre></div>

<p>The next run fails again, with the following denials:</p>
<div class="highlight"><pre><span></span><code>type=AVC msg=audit(1368732806.757:28328): avc:  denied  { create } for  pid=9419 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
type=AVC msg=audit(1368732806.757:28329): avc:  denied  { read } for  pid=9419 comm=&quot;incrond&quot; name=&quot;incron.d&quot; dev=&quot;dm-2&quot; ino=394140 scontext=system_u:system_r:incrond_t tcontext=root:object_r:incron_spool_t tclass=dir
type=AVC msg=audit(1368732806.757:28330): avc:  denied  { create } for  pid=9419 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
type=AVC msg=audit(1368732806.757:28331): avc:  denied  { create } for  pid=9419 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
</code></pre></div>

<p>So although <code>incrond_t</code> has search rights on the <code>incron_spool_t</code>
directories (through the <code>read_files_pattern</code>), we need to grant it
<em>list_dir_perms</em> as well (which contains the <em>read</em> permission). As
<em>list_dir_perms</em> contains search anyhow, we can just update the line
with:</p>
<div class="highlight"><pre><span></span><code>allow incrond_t incron_spool_t:dir list_dir_perms;
allow incrond_t incron_spool_t:file read_file_perms;
</code></pre></div>

<p>Now the startup seems to work, but we still get denials:</p>
<div class="highlight"><pre><span></span><code># run_init rc-service incrond start
* Starting incrond... [ ok ]

# ps -eZ | grep incrond
# tail /var/log/cron.log
(nothing)

# tail audit.log
type=AVC msg=audit(1368733443.799:28340): avc:  denied  { create } for  pid=9551 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
type=AVC msg=audit(1368733443.802:28341): avc:  denied  { write } for  pid=9552 comm=&quot;incrond&quot; name=&quot;/&quot; dev=&quot;tmpfs&quot; ino=1970 scontext=system_u:system_r:incrond_t tcontext=system_u:object_r:var_run_t tclass=dir
type=AVC msg=audit(1368733443.806:28342): avc:  denied  { create } for  pid=9552 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
type=AVC msg=audit(1368733443.806:28343): avc:  denied  { create } for  pid=9552 comm=&quot;incrond&quot; scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=unix_dgram_socket
</code></pre></div>

<p>Those <em>unix_dgram_sockets</em> are here again. But seeing that <code>cron.log</code>
is empty, and <em>logging_send_syslog_msg</em> is one of the interfaces that
would enable it, we might want to do just that so that we get more
information about why <strong>incrond</strong> doesn't properly start. Also, it tries
to write into <code>var_run_t</code> labeled directories, probably for its PID
file, so add in a proper file transition as well as manage rights:</p>
<div class="highlight"><pre><span></span><code>type incrond_var_run_t;
files_pid_file(incrond_var_run_t)
...
allow incrond_t incrond_var_run_t:file manage_file_perms;
files_pid_filetrans(incrond_t, incrond_var_run_t, file)
...
logging_send_syslog_msg(incrond_t)
</code></pre></div>

<p>With that in place:</p>
<div class="highlight"><pre><span></span><code># run_init rc-service incrond start
* Starting incrond... [ ok ]

# ps -eZ | grep incron
system_u:system_r:incrond_t      9648 ?        00:00:00 incrond

# tail /var/log/cron.log 
May 16 21:51:34 test incrond[9647]: starting service (version 0.5.10, built on May 16 2013 12:11:29)
May 16 21:51:34 test incrond[9648]: loading system tables
May 16 21:51:34 test incrond[9648]: loading user tables
May 16 21:51:34 test incrond[9648]: table for invalid user user found (ignored)
May 16 21:51:34 test incrond[9648]: ready to process filesystem events

# tail audit.log
type=AVC msg=audit(1368733894.641:28347): avc:  denied  { read } for  pid=9648 comm=&quot;incrond&quot; name=&quot;nsswitch.conf&quot; dev=&quot;dm-2&quot; ino=393768 scontext=system_u:system_r:incrond_t tcontext=system_u:object_r:etc_t tclass=file
type=AVC msg=audit(1368733894.645:28349): avc:  denied  { read } for  pid=9648 comm=&quot;incrond&quot; name=&quot;passwd&quot; dev=&quot;dm-2&quot; ino=394223 scontext=system_u:system_r:incrond_t tcontext=system_u:object_r:etc_t tclass=file
</code></pre></div>

<p>It looks like we're getting there. Similar as with <strong>incrontab</strong> we
allow <em>auth_use_nsswitch</em> as well, and then get:</p>
<div class="highlight"><pre><span></span><code># tail cron.log
May 16 21:55:10 test incrond[9715]: starting service (version 0.5.10, built on May 16 2013 12:11:29)
May 16 21:55:10 test incrond[9716]: loading system tables
May 16 21:55:10 test incrond[9716]: loading user tables
May 16 21:55:10 test incrond[9716]: loading table for user user
May 16 21:55:10 test incrond[9716]: access denied on /home/user/test2 - events will be discarded silently
May 16 21:55:10 test incrond[9716]: cannot create watch for user user: (13) Permission denied
May 16 21:55:10 test incrond[9716]: ready to process filesystem events

# tail audit.log
type=AVC msg=audit(1368734110.912:28353): avc:  denied  { getattr } for  pid=9716 comm=&quot;incrond&quot; path=&quot;/home/user/test2&quot; dev=&quot;dm-0&quot; ino=16 scontext=system_u:system_r:incrond_t tcontext=user_u:object_r:user_home_t tclass=dir
type=AVC msg=audit(1368734110.913:28354): avc:  denied  { read } for  pid=9716 comm=&quot;incrond&quot; name=&quot;test2&quot; dev=&quot;dm-0&quot; ino=16 scontext=system_u:system_r:incrond_t tcontext=user_u:object_r:user_home_t tclass=dir
</code></pre></div>

<p>What happens is that <strong>incrond</strong> read the (user) crontab, found that it
had to "watch" <code>/home/user/test2</code> but fails because SELinux doesn't
allow it to do so. We could just allow that, but we might do it a bit
better by looking into what we want it to do in a flexible manner...
next time ;-)</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'a-selinux-policy-for-incron-the-incrond-daemon';
                var disqus_url = 'https://blog.siphos.be/2013/05/a-selinux-policy-for-incron-the-incrond-daemon/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>