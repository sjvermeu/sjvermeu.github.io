<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>A SELinux policy for incron: default set - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2013/05/a-selinux-policy-for-incron-default-set/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="booleans,incrond,policy,selinux" />
        <meta name="description" content="I finished the last post a bit with a cliffhanger as incrond is still not working properly, and we got a few denials that needed to be resolved; here they are again for your convenience: type=AVC msg=audit(1368734110.912:28353): avc: denied { getattr } for pid=9716 comm=&#34;incrond …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="A SELinux policy for incron: default set"/>
        <meta property="og:url" content="https://blog.siphos.be/2013/05/a-selinux-policy-for-incron-default-set/"/>
        <meta property="og:description" content="I finished the last post a bit with a cliffhanger as incrond is still not working properly, and we got a few denials that needed to be resolved; here they are again for your convenience: type=AVC msg=audit(1368734110.912:28353): avc: denied { getattr } for pid=9716 comm=&#34;incrond …"/>
        <meta property="article:published_time" content="2013-05-28" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:tag" content="booleans" />
            <meta property="article:tag" content="incrond" />
            <meta property="article:tag" content="policy" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/selinux/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2013/05/a-selinux-policy-for-incron-default-set/"
                       rel="bookmark"
                       title="Permalink to A SELinux policy for incron: default set">
                        A SELinux policy for incron: default set
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-05-28T03:50:00+02:00"> Tue 28 May 2013</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/selinux.html">SELinux</a>


<span class="label label-default">Tags</span>
	<a href="https://blog.siphos.be/tag/booleans/">booleans</a>
        /
	<a href="https://blog.siphos.be/tag/incrond/">incrond</a>
        /
	<a href="https://blog.siphos.be/tag/policy/">policy</a>
        /
	<a href="https://blog.siphos.be/tag/selinux/">selinux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I finished the last post a bit with a
<a href="http://blog.siphos.be/2013/05/a-selinux-policy-for-incron-the-incrond-daemon/">cliffhanger</a>
as <strong>incrond</strong> is still not working properly, and we got a few denials
that needed to be resolved; here they are again for your convenience:</p>
<div class="highlight"><pre><span></span><code>type=AVC msg=audit(1368734110.912:28353): avc:  denied  { getattr } for  pid=9716 comm=&quot;incrond&quot; path=&quot;/home/user/test2&quot; dev=&quot;dm-0&quot; ino=16 scontext=system_u:system_r:incrond_t tcontext=user_u:object_r:user_home_t tclass=dir
type=AVC msg=audit(1368734110.913:28354): avc:  denied  { read } for  pid=9716 comm=&quot;incrond&quot; name=&quot;test2&quot; dev=&quot;dm-0&quot; ino=16 scontext=system_u:system_r:incrond_t tcontext=user_u:object_r:user_home_t tclass=dir
</code></pre></div>


<p>The permission we are looking for here is
<em>userdom_list_user_home_content</em>, but this is only for when we want
to watch a user home directory. What if we want to watch a server upload
directory? Or a cache directory? We might need to have <strong>incrond</strong> have
the proper accesses on all directories. But then again, <em>all</em> does sound
a bit... much, doesn't it? So let's split it up in three waves:</p>
<ol>
<li>The <code>incrond_t</code> domain will support a minimal set of types that it
    can watch, based on common approaches</li>
<li>I will introduce an interface that allows other modules to mark
    specific types as being "watch-worthy"</li>
<li>A boolean will be set to allow <code>incrond_t</code> to watch a very large set
    of types (just in case the admin trusts it sufficiently)</li>
</ol>
<p>Let's first consider a decent minimal set. Within most SELinux policies,
two types are often used for public access (or for uploading of data).
These types are <code>public_content_t</code> and <code>public_content_rw_t</code>, and is
used for instance for FTP definitions (upload folders), HTTP servers and
such. So we introduce the proper rights to watch that data. There is an
interface available called <em>miscfiles_read_public_files</em> but let's
first see if that interface isn't too broad (after all, watching might
not be the same as reading).</p>
<div class="highlight"><pre><span></span><code># This is only to temporarily check if the rights of the interface are too broad or not
# You can set this using &quot;selocal&quot; or in a module (in which case you&#39;ll need to &#39;require&#39;
# the two types)
allow incrond_t public_content_t:dir { read getattr };
</code></pre></div>


<p>After editing the incrontab to watch a directory labeled with
<code>public_content_t</code>, we now get the following:</p>
<div class="highlight"><pre><span></span><code># tail cron.log
May 17 08:46:12 test incrond[9716]: (user) CMD (/usr/local/bin/test)
May 17 08:46:12 test incrond[11281]: cannot exec process: Operation not permitted
May 17 08:46:12 test incrond[9716]: cannot send SIGCHLD token to notification pipe

# tail audit.log
type=AVC msg=audit(1368773172.313:28386): avc:  denied  { setgid } for  pid=11281 comm=&quot;incrond&quot; capability=6  scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=capability
type=AVC msg=audit(1368773172.314:28387): avc:  denied  { read } for  pid=9716 comm=&quot;incrond&quot; path=&quot;pipe:[14027]&quot; dev=&quot;pipefs&quot; ino=14027 scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=fifo_file
type=AVC msg=audit(1368773172.315:28388): avc:  denied  { write } for  pid=9716 comm=&quot;incrond&quot; path=&quot;pipe:[14027]&quot; dev=&quot;pipefs&quot; ino=14027 scontext=system_u:system_r:incrond_t tcontext=system_u:system_r:incrond_t tclass=fifo_file
</code></pre></div>


<p>As the incrontab is a user incrontab, we can expect <code>incrond_t</code> to
require setuid and setgid privileges. Also, the <em>fifo_file</em> access is
after forking (notice the difference in PID values) and most likely to
communicate to the master process. So let's allow those:</p>
<div class="highlight"><pre><span></span><code>allow incrond_t self:capability { setuid setgid };
allow incrond_t self:fifo_file { read write };
</code></pre></div>


<p>With that set, we get the following upon triggering a file write:</p>
<div class="highlight"><pre><span></span><code># tail cron.log
May 17 08:52:46 test incrond[9716]: (user) CMD (/usr/local/bin/test)
May 17 08:52:46 test incrond[11338]: cannot exec process: Permission denied

# tail audit.log
type=AVC msg=audit(1368773566.606:28394): avc:  denied  { read } for  pid=11338 comm=&quot;incrond&quot; name=&quot;ngroups_max&quot; dev=&quot;proc&quot; ino=5711 scontext=system_u:system_r:incrond_t tcontext=system_u:object_r:sysctl_kernel_t tclass=file
type=AVC msg=audit(1368773566.607:28395): avc:  denied  { search } for  pid=11338 comm=&quot;incrond&quot; name=&quot;bin&quot; dev=&quot;dm-3&quot; ino=1048578 scontext=system_u:system_r:incrond_t tcontext=system_u:object_r:bin_t tclass=dir
</code></pre></div>


<p>The <code>ngroups_max</code> pseudo-file (in <code>/proc/sys/kernel</code>) returns the
maximum number of supplementary group IDs per process, and is consulted
through the <em>initgroups()</em> method provided by a system library, so it
<em>might</em> make sense to allow it. For now though, I will not enable it (as
reading <code>sysctl_kernel_t</code> exposes a lot of other system information) but
I might be forced to do so later if things don't work out well. The
<em>search</em> privilege on <code>bin_t</code> is needed to find the script that I have
prepared (<code>/usr/local/bin/test</code>) to be executed, so I add in a
<em>corecmd_search_bin</em> and retry.</p>
<div class="highlight"><pre><span></span><code># tail cron.log
May 17 09:02:55 test incrond[9716]: (user) CMD (/usr/local/bin/test)
May 17 09:02:55 test incrond[11427]: cannot exec process: Permission denied

# tail audit.log
type=AVC msg=audit(1368774175.646:28441): avc:  denied  { read } for  pid=11427 comm=&quot;incrond&quot; name=&quot;sh&quot; dev=&quot;dm-2&quot; ino=131454 scontext=system_u:system_r:incrond_t tcontext=root:object_r:bin_t tclass=lnk_file
</code></pre></div>


<p>Still not there yet apparently. The <strong>incrond</strong> forked process wants to
execute the script, but to do so it has to follow a symbolic link
labeled <code>bin_t</code>. This is because the script points to <code>#!/bin/sh</code> which
is a symlink to the system shell. We need to follow this link before the
execution can occur; only after execution will the transition from
<code>incrond_t</code> to <code>system_cronjob_t</code> be done.</p>
<div class="highlight"><pre><span></span><code>corecmd_read_bin_symlinks(incrond_t)
</code></pre></div>


<p>With that set in the policy, the watch works, <strong>incrond</strong> properly
launches the command and the command properly transitions into
<code>system_cronjob_t</code> as we defined earlier (I check this by echo'ing the
output of <strong>id -Z</strong> into a temporary file).</p>
<p>So we are left with the (temporary) rights we granted on
<code>public_content_t</code>. Consider the rules we had versus the rules applied
with <em>miscfiles_read_public_files</em>:</p>
<div class="highlight"><pre><span></span><code>allow incrond_t public_content_t:dir { read getattr };

# miscfiles_read_public_files
allow $1 { public_content_t public_content_rw_t }:dir list_dir_perms;
read_files_pattern($1, { public_content_t public_content_rw_t }, { public_content_t public_content_rw_t })
read_lnk_files_pattern($1, { public_content_t public_content_rw_t }, { public_content_t public_content_rw_t })
</code></pre></div>


<p>The rights here seem to bemore than what we need. Playing around a bit
with the directories reveals that <strong>incrond</strong> requires a bit more. For
instance, when you create additional directories (subdirectories) and
want to match multiple ones:</p>
<div class="highlight"><pre><span></span><code># tail cron.log
May 17 09:16:08 test incrond[11704]: access denied on /var/www/test/* - events will be discarded silently
May 17 09:16:08 test incrond[11704]: cannot create watch for user user: (13) Permission denied

# tail audit.log
type=AVC msg=audit(1368774968.416:28504): avc:  denied  { search } for  pid=11704 comm=&quot;incrond&quot; name=&quot;test&quot; dev=&quot;dm-4&quot; ino=1488 scontext=system_u:system_r:incrond_t tcontext=root:object_r:public_content_t tclass=dir
type=AVC msg=audit(1368774968.416:28505): avc:  denied  { search } for  pid=11704 comm=&quot;incrond&quot; name=&quot;test&quot; dev=&quot;dm-4&quot; ino=1488 scontext=system_u:system_r:incrond_t tcontext=root:object_r:public_content_t tclass=dir
</code></pre></div>


<p>Similarly if you want to watch on a particular file:</p>
<div class="highlight"><pre><span></span><code>type=AVC msg=audit(1368775274.655:28552): avc:  denied  { getattr } for  pid=11704 comm=&quot;incrond&quot; path=&quot;/var/www/test/testfile&quot; dev=&quot;dm-4&quot; ino=1709 scontext=system_u:system_r:incrond_t tcontext=root:object_r:public_content_t tclass=file
type=AVC msg=audit(1368775274.655:28553): avc:  denied  { read } for  pid=11704 comm=&quot;incrond&quot; name=&quot;testfile&quot; dev=&quot;dm-4&quot; ino=1709 scontext=system_u:system_r:incrond_t tcontext=root:object_r:public_content_t tclass=file
</code></pre></div>


<p>So it looks like <em>miscfiles_read_public_files</em> isn't that bad after
all.</p>
<p>All we are left with is the access to <code>ngroups_max</code>. We can ignore the
calls and make sure they don't show up in standard auditing using
<em>kernel_dontaudit_read_kernel_sysctls</em> or we can allow it with
<em>kernel_read_kernel_sysctls</em>. I'm going to take the former approach
for my system, but your own idea might be different.</p>
<p>I tested all this with user incrontabs (as those are the "most"
advanced) but one can easily test with system incrontabs as well
(placing one in <code>/etc/incron.d</code>). Just be aware that <em>incrond</em> will take
the first match and will not seek other matches. So if a system
incrontab watches <code>/var/www</code> and another line (or user incrontab)
watches <code>/var/www/localhost/upload</code> it is very well possible that only
the <code>/var/www</code> watch is triggered.</p>
<p>So right now, our <code>incrond_t</code> policy looks like so:</p>
<div class="highlight"><pre><span></span><code>###########################################
#
# incrond policy
#

allow incrond_t self:capability { setgid setuid };

allow incrond_t incron_spool_t:dir list_dir_perms;
allow incrond_t incron_spool_t:file read_file_perms;

allow incrond_t self:fifo_file { read write };

allow incrond_t incrond_var_run_t:file manage_file_perms;
files_pid_filetrans(incrond_t, incrond_var_run_t, file)

kernel_dontaudit_read_kernel_sysctls(incrond_t)

corecmd_read_bin_symlinks(incrond_t)
corecmd_search_bin(incrond_t)

files_search_spool(incrond_t)

logging_send_syslog_msg(incrond_t)

auth_use_nsswitch(incrond_t)

miscfiles_read_localization(incrond_t)
miscfiles_read_public_files(incrond_t)
</code></pre></div>


<p>Next on the agenda is another interface to make other types
"watch-worthy".</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'a-selinux-policy-for-incron-default-set';
                var disqus_url = 'https://blog.siphos.be/2013/05/a-selinux-policy-for-incron-default-set/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>