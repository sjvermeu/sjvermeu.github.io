<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Overview of Linux capabilities, part 2 - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2013/05/overview-of-linux-capabilities-part-2/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="capabilities,grsecurity,linux,nosuid,selinux,tpe" />
        <meta name="description" content="As I&#39;ve (in a very high level) described capabilities and talked a bit on how to work with them, I started with a small overview of file-related capabilities. So next up are process-related capabilities (note, this isn&#39;t a conform terminology, more some categorization that I do myself). CAP_IPC_LOCK Allow the …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Overview of Linux capabilities, part 2"/>
        <meta property="og:url" content="https://blog.siphos.be/2013/05/overview-of-linux-capabilities-part-2/"/>
        <meta property="og:description" content="As I&#39;ve (in a very high level) described capabilities and talked a bit on how to work with them, I started with a small overview of file-related capabilities. So next up are process-related capabilities (note, this isn&#39;t a conform terminology, more some categorization that I do myself). CAP_IPC_LOCK Allow the …"/>
        <meta property="article:published_time" content="2013-05-05" />
            <meta property="article:section" content="Security" />
            <meta property="article:tag" content="capabilities" />
            <meta property="article:tag" content="grsecurity" />
            <meta property="article:tag" content="linux" />
            <meta property="article:tag" content="nosuid" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:tag" content="tpe" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/security/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... Security ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2013/05/overview-of-linux-capabilities-part-2/"
                       rel="bookmark"
                       title="Permalink to Overview of Linux capabilities, part 2">
                        Overview of Linux capabilities, part 2
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-05-05T03:50:00+02:00"> Sun 05 May 2013</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/security.html">Security</a>


<span class="label label-default">Tags</span>
	<a href="https://blog.siphos.be/tag/capabilities/">capabilities</a>
        /
	<a href="https://blog.siphos.be/tag/grsecurity/">grsecurity</a>
        /
	<a href="https://blog.siphos.be/tag/linux/">linux</a>
        /
	<a href="https://blog.siphos.be/tag/nosuid/">nosuid</a>
        /
	<a href="https://blog.siphos.be/tag/selinux/">selinux</a>
        /
	<a href="https://blog.siphos.be/tag/tpe/">tpe</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>As I've (in a very high level) <a href="http://blog.siphos.be/2013/05/capabilities-a-short-intro/">described
capabilities</a>
and talked a bit on how to <a href="http://blog.siphos.be/2013/05/restricting-and-granting-capabilities/">work with
them</a>,
I started with a small overview of
<a href="http://blog.siphos.be/2013/05/overview-of-linux-capabilities-part-1/">file-related</a>
capabilities. So next up are process-related capabilities (note, this
isn't a conform terminology, more some categorization that I do myself).</p>
<dl>
<dt>CAP_IPC_LOCK</dt>
<dd>Allow the process to lock memory</dd>
<dt>CAP_IPC_OWNER</dt>
<dd>Bypass the permission checks for operations on System V IPC objects
(similar to the <code>CAP_DAC_OVERRIDE</code> for files)</dd>
<dt>CAP_KILL</dt>
<dd>Bypass permission checks for sending signals</dd>
<dt>CAP_SETUID</dt>
<dd>Allow the process to make arbitrary manipulations of process UIDs
and create forged UID when passing socket credentials via UNIX
domain sockets</dd>
<dt>CAP_SETGID</dt>
<dd>Same, but then for GIDs</dd>
<dt>CAP_SYS_NICE</dt>
<dd>
<p>This capability governs several permissions/abilities, namely to
allow the process to
</p>
-   change the <em>nice</em> value of itself and other processes
-   set real-time scheduling priorities for itself, and set
    scheduling policies and priorities for arbitrary processes
-   set the CPU affinity for arbitrary processes
-   apply <em>migrate_pages</em> to arbitrary processes and allow
    processes to be migrated to arbitrary nodes
-   apply <em>move_pages</em> to arbitrary processes
-   use the <code>MPOL_MF_MOVE_ALL</code> flag with <em>mbind()</em> and
    <em>move_pages()</em></p>
<p><p>
The abilities related to page moving, migration and nodes is of
importance for NUMA systems, not something most workstations have
or need.</p>
</dd>
<dt>CAP_SYS_PACCT</dt>
<dd>Use <em>acct()</em>, to enable or disable system resource accounting for
the process</dd>
<dt>CAP_SYS_PTRACE</dt>
<dd>Allow the process to trace arbitrary processes using <em>ptrace()</em>,
apply <em>get_robust_list()</em> against arbitrary processes and inspect
processes using <em>kcmp()</em>.</dd>
<dt>CAP_SYS_RAWIO</dt>
<dd>Allow the process to perform I/O port operations, access
<code>/proc/kcore</code> and employ the <code>FIBMAP</code> <em>ioctl()</em> operation.</dd>
</dl>
<p>Capabilities such as <code>CAP_KILL</code> and <code>CAP_SETUID</code> are very important to
govern correctly, but this post would be rather dull (given that the
definitions of the above capabilities can be found from the manual page)
if I wouldn't talk a bit more about its feasibility. Take a look at the
following C application code:</p>
<div class="highlight"><pre><span></span><code>#include &lt;errno.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/capability.h&gt;
#include &lt;sys/prctl.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char ** argv) {
  printf(&quot;cap_setuid and cap_setgid: %d\n&quot;, prctl(PR_CAPBSET_READ, CAP_SETUID|CAP_SETGID, 0, 0, 0));
  printf(&quot; %s\n&quot;, cap_to_text(cap_get_file(argv[0]), NULL));
  printf(&quot; %s\n&quot;, cap_to_text(cap_get_proc(), NULL));
  if (setresuid(0, 0, 0));
    printf(&quot;setresuid(): %s\n&quot;, strerror(errno));
  execve(&quot;/bin/sh&quot;, NULL, NULL);
}
</code></pre></div>


<p>At first sight, it looks like an application to get root privileges
(<em>setresuid()</em>) and then spawn a shell. If that application would be
given <code>CAP_SETUID</code> and <code>CAP_SETGID</code> effectively, it would allow anyone
who executed it to automatically get a root shell, wouldn't it?</p>
<div class="highlight"><pre><span></span><code>$ gcc -o test -lcap test.c
# setcap cap_setuid,cap_setgid+ep test
$ ./test
cap_setuid and cap_setgid: 1
 = cap_setgid,cap_setuid+ep
 =
setresuid() failed: Operation not permitted
</code></pre></div>


<p>So what happened? After all, the two capabilities are set with the <em>+ep</em>
flags given. Then why aren't these capabilities enabled? Well, this
binary was stored on a file system that is mounted with the <em>nosuid</em>
option. As a result, this capability is <em>not</em> enabled and the
application didn't work. If I move the file to another file system that
doesn't have the <em>nosuid</em> option:</p>
<div class="highlight"><pre><span></span><code>$ /usr/local/bin/test
cap_setuid and cap_setgid: 1
 = cap_setgid,cap_setuid+ep
 = cap_setgid,cap_setuid+ep
setresuid() failed: Operation not permitted
</code></pre></div>


<p>So the capabilities now do get enabled, so why does this still fail?
This now is due to SELinux:</p>
<div class="highlight"><pre><span></span><code>type=AVC msg=audit(1367393377.342:4778): avc:  denied  { setuid } for  pid=21418 comm=&quot;test&quot; capability=7  scontext=staff_u:staff_r:staff_t tcontext=staff_u:staff_r:staff_t tclass=capability
</code></pre></div>


<p>And if you enable grSecurity's TPE, we can't even start the binary to
begin with:</p>
<div class="highlight"><pre><span></span><code>$ ./test
-bash: ./test: Permission denied
$ /lib/ld-linux-x86-64.so.2 /home/test/test
/home/test/test: error while loading shared libraries: /home/test/test: failed to map segment from shared object: Permission denied

# dmesg
...
[ 5579.567842] grsec: From 192.168.100.1: denied untrusted exec (due to not being in trusted group and file in non-root-owned directory) of /home/test/test by /home/test/test[bash:4221] uid/euid:1002/1002 gid/egid:100/100, parent /bin/bash[bash:4195] uid/euid:1002/1002 gid/egid:100/100
</code></pre></div>


<p>When all these "security obstacles" are not enabled, then the call
succeeds:</p>
<div class="highlight"><pre><span></span><code>$ /usr/local/bin/test
cap_setuid and cap_setgid: 1
 = cap_setgid,cap_setuid+ep
 = cap_setgid,cap_setuid+ep
setresuid() failed: Success
root@hpl tmp #
</code></pre></div>


<p>This again shows how important it is to regularly review
capability-enabled files on the file system, as this is a major security
problem that cannot be detected by only looking for setuid binaries, but
also that securing a system is not limited to one or a few settings: one
always has to take the entire setup into consideration, hardening the
system so it becomes more difficult for malicious users to abuse it.</p>
<div class="highlight"><pre><span></span><code># filecap -a
file                 capabilities
/usr/local/bin/test     setgid, setuid
</code></pre></div>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'overview-of-linux-capabilities-part-2';
                var disqus_url = 'https://blog.siphos.be/2013/05/overview-of-linux-capabilities-part-2/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>