<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Separate puppet provider for Gentoo/SELinux? - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2013/04/separate-puppet-provider-for-gentooselinux/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="Gentoo,openrc,provider,puppet,selinux" />
        <meta name="description" content="While slowly transitioning my playground infrastructure towards Puppet, I already am in process of creating a custom provider for things such as services. Puppet uses providers as &#34;implementations&#34; for the functions Puppet needs. For instance, for the service type (which handles init script services), there are providers for RedHat, Debian …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Separate puppet provider for Gentoo/SELinux?"/>
        <meta property="og:url" content="https://blog.siphos.be/2013/04/separate-puppet-provider-for-gentooselinux/"/>
        <meta property="og:description" content="While slowly transitioning my playground infrastructure towards Puppet, I already am in process of creating a custom provider for things such as services. Puppet uses providers as &#34;implementations&#34; for the functions Puppet needs. For instance, for the service type (which handles init script services), there are providers for RedHat, Debian …"/>
        <meta property="article:published_time" content="2013-04-07" />
            <meta property="article:section" content="Gentoo" />
            <meta property="article:tag" content="Gentoo" />
            <meta property="article:tag" content="openrc" />
            <meta property="article:tag" content="provider" />
            <meta property="article:tag" content="puppet" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/gentoo/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... Gentoo ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2013/04/separate-puppet-provider-for-gentooselinux/"
                       rel="bookmark"
                       title="Permalink to Separate puppet provider for Gentoo/SELinux?">
                        Separate puppet provider for Gentoo/SELinux?
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-04-07T19:22:00+02:00"> Sun 07 April 2013</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/gentoo.html">Gentoo</a>


<span class="label label-default">Tags</span>
	<a href="https://blog.siphos.be/tag/gentoo/">Gentoo</a>
        /
	<a href="https://blog.siphos.be/tag/openrc/">openrc</a>
        /
	<a href="https://blog.siphos.be/tag/provider/">provider</a>
        /
	<a href="https://blog.siphos.be/tag/puppet/">puppet</a>
        /
	<a href="https://blog.siphos.be/tag/selinux/">selinux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>While slowly transitioning my playground infrastructure towards Puppet,
I already am in process of creating a custom provider for things such as
services. Puppet uses providers as "implementations" for the functions
Puppet needs. For instance, for the <em>service</em> type (which handles init
script services), there are providers for RedHat, Debian, FreeBSD, ...
and it also has providers called <em>gentoo</em> and <em>openrc</em>. The <em>openrc</em> one
uses the service scripts that Gentoo's OpenRC provides, such as
<strong>rc-service</strong> and <strong>rc-status</strong>.</p>
<p>On a SELinux-enabled system, and especially when using a decentralized
Puppet environment (I dropped the puppet master set in favor of a
decentralized usage of Puppet), if you call <strong>rc-service</strong> to, say,
start a service, it will ask for the users' password. Of course, Puppet
doesn't want this, so I have to prefix the commands with <strong>run_init</strong>
and have a <code>pam_rootok.so</code> rule in run_init's PAM definition.</p>
<p>So far that's a simple change - I just patched the <code>openrc.rb</code> file to
do so. But then the second problem I'm facing is that Puppet wants to
use return code based commands for checking the run-time state of
services. Even though some of my services weren't running, Puppet either
thought they were or called the start routine and consider the service
started. Sadly that wasn't the case, as the rc-* scripts always return
0 (you'll need to parse the output).</p>
<p>So what I did now is to create a simple script called <code>runstatus</code> which
returns the state of services. It's crude, but seems to work:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>

<span class="nv">SERVICENAME</span><span class="o">=</span><span class="nv">$1</span><span class="p">;</span>

<span class="c1"># We need to exit:</span>
<span class="c1"># 0 - if running</span>
<span class="c1"># 1 - if dead but PID exists</span>
<span class="c1"># 2 - if dead but lock file exists</span>
<span class="c1"># 3 - if not running</span>
<span class="c1"># 4 - if unknown</span>

rc-status -a -C <span class="p">|</span> grep <span class="si">${</span><span class="nv">SERVICENAME</span><span class="si">}</span> <span class="p">|</span> grep -q started <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span><span class="p">;</span>
rc-status -a -C <span class="p">|</span> grep <span class="si">${</span><span class="nv">SERVICENAME</span><span class="si">}</span> <span class="p">|</span> grep -q stopped <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">3</span><span class="p">;</span>
<span class="nb">exit</span> <span class="m">4</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>

<p>I then have the service provider (I now provide my own instead of
patching the openrc one) call <strong>runstatus</strong> to get the state of a
service, as well as call it after trying to start a service. But as this
is quite basic functioning, I'm wondering if I'm doing things the right
way or not. Who else has experience with Puppet and Gentoo, and did you
have to tweak things to get services and such working?</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'separate-puppet-provider-for-gentooselinux';
                var disqus_url = 'https://blog.siphos.be/2013/04/separate-puppet-provider-for-gentooselinux/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>