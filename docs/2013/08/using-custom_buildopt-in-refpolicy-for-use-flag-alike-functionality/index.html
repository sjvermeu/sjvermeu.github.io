<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Using CUSTOM_BUILDOPT in refpolicy for USE flag-alike functionality? - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2013/08/using-custom_buildopt-in-refpolicy-for-use-flag-alike-functionality/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="boolean,Gentoo,policy,selinux,use,useflag" />
        <meta name="description" content="As you are probably aware, Gentoo uses the reference policy as its base for SELinux policies. Yes, we do customize it and not everything is already pushed upstream (for instance, our approach to use xdg_*_home_t customizable types to further restrict user application access has been sent up for comments …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Using CUSTOM_BUILDOPT in refpolicy for USE flag-alike functionality?"/>
        <meta property="og:url" content="https://blog.siphos.be/2013/08/using-custom_buildopt-in-refpolicy-for-use-flag-alike-functionality/"/>
        <meta property="og:description" content="As you are probably aware, Gentoo uses the reference policy as its base for SELinux policies. Yes, we do customize it and not everything is already pushed upstream (for instance, our approach to use xdg_*_home_t customizable types to further restrict user application access has been sent up for comments …"/>
        <meta property="article:published_time" content="2013-08-16" />
            <meta property="article:section" content="Gentoo" />
            <meta property="article:tag" content="boolean" />
            <meta property="article:tag" content="Gentoo" />
            <meta property="article:tag" content="policy" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:tag" content="use" />
            <meta property="article:tag" content="useflag" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/gentoo/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... Gentoo ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2013/08/using-custom_buildopt-in-refpolicy-for-use-flag-alike-functionality/"
                       rel="bookmark"
                       title="Permalink to Using CUSTOM_BUILDOPT in refpolicy for USE flag-alike functionality?">
                        Using CUSTOM_BUILDOPT in refpolicy for USE flag-alike functionality?
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-08-16T09:17:00+02:00"> Fri 16 August 2013</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/gentoo.html">Gentoo</a>


<span class="label label-default">Tags</span>
	<a href="https://blog.siphos.be/tag/boolean/">boolean</a>
        /
	<a href="https://blog.siphos.be/tag/gentoo/">Gentoo</a>
        /
	<a href="https://blog.siphos.be/tag/policy/">policy</a>
        /
	<a href="https://blog.siphos.be/tag/selinux/">selinux</a>
        /
	<a href="https://blog.siphos.be/tag/use/">use</a>
        /
	<a href="https://blog.siphos.be/tag/useflag/">useflag</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>As you are probably aware, Gentoo uses the <a href="http://oss.tresys.com/projects/refpolicy/">reference
policy</a> as its base for
SELinux policies. Yes, we do customize it and not everything is already
pushed upstream (for instance, our approach to use <code>xdg_*_home_t</code>
customizable types to further restrict user application access has been
sent up for comments a few times but we still need to iron it out
further) but all in all, we're pretty close to the upstream releases.
This is also visible when there are changes upstream as we very easily
integrate them back in our repository.</p>
<p>But there are still a few things that I want to implement further, and
one of these things is perhaps too specific for Gentoo but would benefit
us (security-wise) in great detail: enabling domain privileges based on
USE flags. Allow me to quickly use an example to make this more
tangible.</p>
<p>Consider the MPlayer application. As a media application, it of course
offers support for ALSA and PulseAudio (amongst other things). In the
SELinux policy, support for (and thus privileges related to) ALSA and
PulseAudio is handled through <em>optional_policy</em> statements:</p>
<div class="highlight"><pre><span></span><code>optional_policy(`
  pulseaudio_tmpfs_content(mplayer_tmpfs_t)
&#39;)
</code></pre></div>


<p>This means that the rules defined in <em>pulseaudio_tmpfs_content</em> are
executed if the dependencies match:</p>
<div class="highlight"><pre><span></span><code>interface(`pulseaudio_tmpfs_content&#39;,`
        gen_require(`
                attribute pulseaudio_tmpfsfile;
        &#39;)

        typeattribute $1 pulseaudio_tmpfsfile;
&#39;)
</code></pre></div>


<p>If the <code>pulseaudio_tmpfsfile</code> attribute exists, then the
<code>mplayer_tmpfs_t</code> type gets the <code>pulseaudio_tmpfsfile</code> attribute
assigned to it.</p>
<p>This is flexible, because if the server/workstation does not use
PulseAudio, then in Gentoo, no pulseaudio SELinux module will be loaded
and thus the attribute will not exist. However, Gentoo tries to be a bit
more flexible in this - it is very well possible to have PulseAudio
installed, but disable PulseAudio support in MPlayer (build mplayer with
USE="-pulseaudio"). The current definitions in the policy do not support
this flexibility: if the pulseaudio module is loaded, then the
privileges become active.</p>
<p>One way SELinux supports a more flexible approach is to use conditionals
in the policy. One could create booleans that administrators can toggle
to enable / disable SELinux rules. For instance, in the mplayer policy:</p>
<div class="highlight"><pre><span></span><code>tunable_policy(`allow_mplayer_execstack&#39;,`
        allow mencoder_t self:process { execmem execstack };
&#39;)
</code></pre></div>


<p>If an administrator toggles the <code>allow_mplayer_execstack</code> boolean to
"on", then the mentioned <code>allow</code> rule becomes active.</p>
<p>Sadly, this approach is not fully usable for USE driven decisions. Not
all rules can be enclosed in <code>tunable_policy</code> statements, and <a href="http://oss.tresys.com/pipermail/refpolicy/2013-July/006452.html">assigning
attributes to a
type</a>
is one of them (cfr our pulseaudio example). A recent discussion on the
reference policy mailinglist gave me two ideas to investigate:</p>
<ul>
<li>See if we can support CIL (a new language for SELinux
    policy definitions) where such an approach would be easier</li>
<li>Use build-time decisions</li>
</ul>
<p>In this post, I want to go through the <em>build-time decisions</em> idea. The
reference policy supports build-time options using <em>ifdef</em> constructs.
These look at parameters provided by the build system (M4/Makefile
based) to see if rules need to be activated or not. For type attribute
declarations, this is a valid approach. So one idea would be to
transform USE flags, if they are set, into <code>use_${USEFLAG}</code>, and make
decisions based on this in the policy code:</p>
<div class="highlight"><pre><span></span><code>ifdef(`use_pulseaudio&#39;,`
  optional_policy(`
    pulseaudio_tmpfs_content(mplayer_tmpfs_t)
  &#39;)
&#39;)
</code></pre></div>


<p>We can add in the USE flags, if set, through the <code>CUSTOM_BUILDOPT</code>
parameter that the reference policy provides. So introducing this is not
that difficult. The only thing I'm currently a bit weary about is the
impact on the policy files themselves (which is why I haven't done this
already) and the fact that USE flags on the "real" package are not know
to policy packages. In other words, if a user explicitly marks
<code>USE="-pulseaudio"</code> on mplayer, but has <code>USE="pulseaudio"</code> set as
general value, then the <code>selinux-mplayer</code> package will still have
pulseaudio enabled.</p>
<p>Still, I do like the idea. It would make it more consistent with what
Gentoo aims to do: if you do not want a certain support/feature in the
code, then why would the policy still have to allow it? With the proper
documentation towards administrators, I think this would be a good
approach.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'using-custom_buildopt-in-refpolicy-for-use-flag-alike-functionality';
                var disqus_url = 'https://blog.siphos.be/2013/08/using-custom_buildopt-in-refpolicy-for-use-flag-alike-functionality/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>