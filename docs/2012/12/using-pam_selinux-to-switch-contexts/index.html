<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Using pam_selinux to switch contexts - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2012/12/using-pam_selinux-to-switch-contexts/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="description" content="With SELinux managing the access controls of applications towards the resources on the system, a not-to-be forgotten important component on any Unix/Linux system is the authentication part. Most systems use or support PAM, the Pluggable Authentication Modules, and for SELinux this plays an important role. Applications that are PAM-enabled …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Using pam_selinux to switch contexts"/>
        <meta property="og:url" content="https://blog.siphos.be/2012/12/using-pam_selinux-to-switch-contexts/"/>
        <meta property="og:description" content="With SELinux managing the access controls of applications towards the resources on the system, a not-to-be forgotten important component on any Unix/Linux system is the authentication part. Most systems use or support PAM, the Pluggable Authentication Modules, and for SELinux this plays an important role. Applications that are PAM-enabled …"/>
        <meta property="article:published_time" content="2012-12-10" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/selinux/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2012/12/using-pam_selinux-to-switch-contexts/"
                       rel="bookmark"
                       title="Permalink to Using pam_selinux to switch contexts">
                        Using pam_selinux to switch contexts
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2012-12-10T22:11:00+01:00"> Mon 10 December 2012</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/selinux.html">SELinux</a>


    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>With SELinux managing the access controls of applications towards the
resources on the system, a not-to-be forgotten important component on
any Unix/Linux system is the authentication part. Most systems use or
support PAM, the <em>Pluggable Authentication Modules</em>, and for SELinux
this plays an important role.</p>
<p>Applications that are PAM-enabled use PAM for the authentication of user
activities. If this includes setting up an authenticated session, then
the "session" part of the PAM configuration is also handled. And for
SELinux, this is a nice-to-have, since this means applications that are
not SELinux-aware can still enjoy transitions towards specified domains
depending on the user that is authenticated.</p>
<p>The "not SELinux-aware" here is important. By default, applications keep
running in one security context for their lifetime. If they invoke a
<code>execve</code> or similar call (which is used to start another application or
command when used in combination with a <code>fork</code>), then the SELinux policy
<em>might</em> trigger an automatic transition if the holy grail of fourfold
rules is set:</p>
<ol>
<li>a transition from the current context to the new one is allowed</li>
<li>the label of the executed command/label is marked as an entrypoint
    for the new context</li>
<li>the current context is allowed to execute that application</li>
<li>an automatic transition rule is made from the current context to the
    new one over the command label</li>
</ol>
<p>Or, in SELinux policy terms, assuming the domains are <code>source_t</code> and
<code>destination_t</code> with the label of the executed file being <code>file_exec_t</code>:</p>
<div class="highlight"><pre><span></span><code>allow source_t destination_t:process transition;
allow destination_t file_exec_t:file entrypoint;
allow source_t file_exec_t:file execute;
type_transition source_t file_exec_t : process destination_t;
</code></pre></div>


<p>If those four settings are valid, then (and only then) can the automatic
transition be active.</p>
<p>Sadly, for applications that run user actions (like cron systems, remote
logon services and more) this is not sufficient, since there are two
major downsides to this "flexibility":</p>
<ol>
<li>The rules to transition are static and do not depend on the identity
    of the user for which activities are launched. The policy can not
    deduce this identity from a file context either.</li>
<li>The policy is statically defined: different transitions based on
    different user identities are not possibel.</li>
</ol>
<p>To overcome this problem, applications can be made SELinux-aware,
linking with the libselinux library and invoking the necessary switches
themselves (or running the commands with <code>runcon</code>). Luckily, this is
where the PAM system comes to play to aide us in setting up this policy
behavior.</p>
<p>When an application is PAM-enabled, it will invoke PAM calls to
authenticate and possibly set up the user session. The actions that PAM
invokes are defined by the PAM configuration files. For instance, for
the at daemon:</p>
<div class="highlight"><pre><span></span><code>## /etc/pam.d/atd
#
# The PAM configuration file for the at daemon
#

auth    required        pam_env.so
auth    include         system-services
account include         system-services
session include         system-services
</code></pre></div>


<p>I am not going to dive into the details of PAM in this blog post, so
let's just jump to the session management part. In the above example
file, if PAM sets up (or shuts down) a user session for the service (at
in our case), it will go through the PAM services that are listed in the
<em>system-services</em> definition, which looks like so:</p>
<div class="highlight"><pre><span></span><code>## /etc/pam.d/system-services
auth            sufficient      pam_permit.so
account         include         system-auth
session         optional        pam_loginuid.so
session         required        pam_limits.so 
session         required        pam_env.so 
session         required        pam_unix.so 
session         optional        pam_permit.so
</code></pre></div>


<p>Until now, nothing SELinux-specific is enabled. But if we change the
session section of the at service to the following, then the SELinux pam
module will be called as well:</p>
<div class="highlight"><pre><span></span><code>session optional        pam_selinux.so close
session include         system-services
session optional        pam_selinux.so multiple open
</code></pre></div>


<p>Now that the SELinux module is called, pam_selinux will try to switch
the context of the process based on the definitions in the
/etc/selinux/strict/contexts location (substitute strict with the policy
type you use). The outcome of this switching can be checked with the
<strong>getseuser</strong> application:</p>
<div class="highlight"><pre><span></span><code>~# getseuser root system_u:system_r:crond_t
seuser:  root, level (null)
Context 0       root:sysadm_r:cronjob_t
Context 1       root:staff_r:cronjob_t
</code></pre></div>


<p>By providing the contexts in configurable files in
/etc/selinux/strict/contexts, a non-SELinux aware application suddenly
becomes SELinux-aware (through the PAM support it already has) without
needing to patch or even rebuild the application. All that is need is to
allow the security context of the application to switch ids and roles
(as that is by default not allowed), which I believe is offered through
the following statements:</p>
<div class="highlight"><pre><span></span><code>domain_subj_id_change_exemption(atd_t)
domain_role_change_exemption(atd_t)

selinux_validate_context(atd_t)
selinux_compute_access_vector(atd_t)
selinux_compute_create_context(atd_t)
selinux_compute_relabel_context(atd_t)
selinux_compute_user_contexts(atd_t)

seutil_read_config(atd_t)
seutil_read_default_contexts(atd_t)
</code></pre></div>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'using-pam_selinux-to-switch-contexts';
                var disqus_url = 'https://blog.siphos.be/2012/12/using-pam_selinux-to-switch-contexts/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>