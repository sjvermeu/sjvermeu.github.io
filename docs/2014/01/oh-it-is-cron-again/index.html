<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Oh it is cron again... - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2014/01/oh-it-is-cron-again/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="cron,selinux" />
        <meta name="description" content="Today I was pointed to the following error: test fcron[6722]: fcron[6722] 3.1.2 started test fcron[6722]: Cannot bind socket to &#39;/var/run/fcron.fifo&#39;: Permission denied test fcron[6722]: &#34;at&#34; reboot jobs will only be run at computer&#39;s startup. test fcron[6722]: updating configuration from …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Oh it is cron again..."/>
        <meta property="og:url" content="https://blog.siphos.be/2014/01/oh-it-is-cron-again/"/>
        <meta property="og:description" content="Today I was pointed to the following error: test fcron[6722]: fcron[6722] 3.1.2 started test fcron[6722]: Cannot bind socket to &#39;/var/run/fcron.fifo&#39;: Permission denied test fcron[6722]: &#34;at&#34; reboot jobs will only be run at computer&#39;s startup. test fcron[6722]: updating configuration from …"/>
        <meta property="article:published_time" content="2014-01-03" />
            <meta property="article:section" content="SELinux" />
            <meta property="article:tag" content="cron" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/selinux/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... SELinux ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2014/01/oh-it-is-cron-again/"
                       rel="bookmark"
                       title="Permalink to Oh it is cron again...">
                        Oh it is cron again...
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-01-03T21:05:00+01:00"> Fri 03 January 2014</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/selinux.html">SELinux</a>


<span class="label label-default">Tags</span>
	<a href="https://blog.siphos.be/tag/cron/">cron</a>
        /
	<a href="https://blog.siphos.be/tag/selinux/">selinux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Today I was pointed to the following error:</p>
<div class="highlight"><pre><span></span><code>test fcron[6722]: fcron[6722] 3.1.2 started
test fcron[6722]: Cannot bind socket to &#39;/var/run/fcron.fifo&#39;: Permission denied
test fcron[6722]:  &quot;at&quot; reboot jobs will only be run at computer&#39;s startup.
test fcron[6722]: updating configuration from /var/spool/fcron
test fcron[6722]: adding file systab Jan  3 17:51:19 test fcron[6722]: adding new file user
test fcron[6722]: NO CONTEXT for user &quot;(null)&quot;: Invalid argument
test fcron[6722]: ENTRYPOINT FAILED for user &quot;user&quot; (CONTEXT (null)) for file CONTEXT user_u:object_r:user_cron_spool_t:s0
</code></pre></div>


<p>First of all, the moment I notice that it is cron, I know I'm up for a
few hours at it. Cron has been notoriously difficult to integrate with
SELinux, because it doesn't use the simpler "fork-execute" method (where
we can put in transitions). Instead, it often has to call
SELinux-specific methods to get the job done. Same was true here.</p>
<p>Anyway, on to the issues. First of all, the <em>Cannot bind socket</em> is a
simple SELinux policy thingie that one can easily ignore for now (I'll
patch and upstream that in a minute). The problem is the <em>NO CONTEXT</em>
stuff.</p>
<p>The code looks as follows:</p>
<p>``` {lang="c"}</p>
<h1>ifdef SYSFCRONTAB</h1>
<div class="highlight"><pre><span></span><code>if(!strcmp(cf-&gt;cf_user, SYSFCRONTAB))
    user_name = &quot;system_u&quot;;
else
</code></pre></div>


<h1>endif /<em> def SYSFCRONTAB </em>/</h1>
<div class="highlight"><pre><span></span><code>    user_name = cf-&gt;cf_user;
if(flask_enabled)
{
    if(get_default_context(user_name, NULL, &amp;cf-&gt;cf_user_context))
        error_e(&quot;NO CONTEXT for user \&quot;%s\&quot;&quot;, cf-&gt;cf_user_context);
    retval = security_compute_av(cf-&gt;cf_user_context, cf-&gt;cf_file_context
            , SECCLASS_FILE, FILE__ENTRYPOINT, &amp;avd);

    if(retval || ((FILE__ENTRYPOINT &amp; avd.allowed) != FILE__ENTRYPOINT))
    {
        syslog(LOG_ERR, &quot;ENTRYPOINT FAILED for user \&quot;%s\&quot; &quot;
               &quot;(CONTEXT %s) for file CONTEXT %s&quot;
               , cf-&gt;cf_user, cf-&gt;cf_user_context, cf-&gt;cf_file_context);
        goto err;
    }
</code></pre></div>


<p>```</p>
<p>It wasn't obvious to me either, but from a quick look through the
<a href="http://userspace.selinuxproject.org/trac/browser/libselinux/include/selinux/selinux.h">selinux.h</a>
code I found out that <em>get_default_context()</em> requires the SELinux
user rather than Linux user.</p>
<p>The purpose of the <em>get_default_context()</em> method is to return the
SELinux context in which newly started tasks, originating from the
current context (if second argument is <em>NULL</em>) or given context (second
argument), owned by the given user (first argument) should start in. In
case of cron, the code is asking SELinux what the context should be for
the cronjob itself, considering that it has to be executed for a given
user.</p>
<p>Now the code currently passes on the owner (Linux user) of the crontab
file. As this owner usually is not a SELinux user (only when there is a
SELinux user named after the Linux user will this succeed), the method
returns <em>NULL</em>.</p>
<p>The right call here would be to first look up the correct SELinux user
for the given Linux user, and then call the <em>get_default_context()</em>
method. This will return a context to transition to.</p>
<p>Now, cron systems usually do a second check - they see if the file in
which the cronjobs are mentioned is an <em>entrypoint</em> for the context that
it should transition to. Even though the file itself will not be
directly executed, by checking if the <em>entrypoint</em> permission is set
cron can be reasonably certain that it should proceed. So for cron, this
is like saying "Yes, the file with context <code>cron_spool_t</code> is allowed to
contain job definitions for cron to execute".</p>
<p>I've sent the
<a href="http://thread.gmane.org/gmane.comp.sysutils.fcron.devel/89">patch</a> for
this upstream and hopefully it gets added in - if I'm correct in the
deduction, that is.</p>
<p>So when you get issues with cron, do the following checks:</p>
<ol>
<li>Is the cron daemon running in the right domain? It should run in a
    <code>crond_t</code> domain, otherwise it will not be able to get a proper
    default context.</li>
<li>Assuming that cron uses the right arguments, make sure that a
    default context is set for the given SELinux user (check the
    <code>contexts/default_contexts</code> and <code>contexts/users/*</code> files) and that
    this context is valid</li>
<li>Check the context of the file in which the definitions are stored
    and make sure it is mentioned as an entrypoint for the job domain</li>
</ol>
<p>Or, in some code:</p>
<div class="highlight"><pre><span></span><code># ps -efZ | grep fcron | awk &#39;{print $1}&#39;
system_u:system_r:crond_t
# getseuser swift system_u:system_r:crond_t
seuser: user_u
Context 0     user_u:user_r:cronjob_t
# ls -lZ /var/spool/fcron/new.user
... user_u:object_r:user_cron_spool_t
# sesearch -s cronjob_t -t user_cron_spool_t -c file -p entrypoint -A
Found 1 semantic av rules:
  allow cronjob_t user_cron_spool_t : file entrypoint ;
</code></pre></div>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'oh-it-is-cron-again';
                var disqus_url = 'https://blog.siphos.be/2014/01/oh-it-is-cron-again/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>