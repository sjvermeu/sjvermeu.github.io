<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Proof of concept for USE enabled policies - Simplicity is a form of art...</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.siphos.be/2014/03/proof-of-concept-for-use-enabled-policies/">

        <meta name="author" content="Sven Vermeulen" />
        <meta name="keywords" content="alsa,policy,selinux" />
        <meta name="description" content="tl;dr: Some (-9999) policy ebuilds now have USE support for building in (or leaving out) SELinux policy statements. One of the &#34;problems&#34; I have been facing since I took on the maintenance of SELinux policies within Gentoo Hardened is the (seeming) inability to make a &#34;least privilege&#34; policy that …" />

        <meta property="og:site_name" content="Simplicity is a form of art..." />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Proof of concept for USE enabled policies"/>
        <meta property="og:url" content="https://blog.siphos.be/2014/03/proof-of-concept-for-use-enabled-policies/"/>
        <meta property="og:description" content="tl;dr: Some (-9999) policy ebuilds now have USE support for building in (or leaving out) SELinux policy statements. One of the &#34;problems&#34; I have been facing since I took on the maintenance of SELinux policies within Gentoo Hardened is the (seeming) inability to make a &#34;least privilege&#34; policy that …"/>
        <meta property="article:published_time" content="2014-03-31" />
            <meta property="article:section" content="Gentoo" />
            <meta property="article:tag" content="alsa" />
            <meta property="article:tag" content="policy" />
            <meta property="article:tag" content="selinux" />
            <meta property="article:author" content="Sven Vermeulen" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.siphos.be/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://blog.siphos.be/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.siphos.be/theme/css/pygments/native.css" rel="stylesheet">
    <link href="https://blog.siphos.be/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.siphos.be/theme/css/style.css" type="text/css"/>

        <link href="https://blog.siphos.be/feed/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... ATOM Feed"/>

        <link href="https://blog.siphos.be/feed/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Simplicity is a form of art... RSS Feed"/>


        <link href="https://blog.siphos.be/category/gentoo/feed/atom.xml" type="application/atom+xml" rel="alternate"
              title="Simplicity is a form of art... Gentoo ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.siphos.be/" class="navbar-brand">
Simplicity is a form of art...            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.siphos.be/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.siphos.be/2014/03/proof-of-concept-for-use-enabled-policies/"
                       rel="bookmark"
                       title="Permalink to Proof of concept for USE enabled policies">
                        Proof of concept for USE enabled policies
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-03-31T18:33:00+02:00"> Mon 31 March 2014</time>
    </span>


            <span class="label label-default">By</span>
            <a href="https://blog.siphos.be/pages/about.html"><i class="fa fa-user"></i> Sven Vermeulen</a>

        <span class="label label-default">Category</span>
        <a href="https://blog.siphos.be/category/gentoo.html">Gentoo</a>


<span class="label label-default">Tags</span>
	<a href="https://blog.siphos.be/tag/alsa/">alsa</a>
        /
	<a href="https://blog.siphos.be/tag/policy/">policy</a>
        /
	<a href="https://blog.siphos.be/tag/selinux/">selinux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p><em>tl;dr:</em> Some (<code>-9999</code>) policy ebuilds now have <code>USE</code> support for
building in (or leaving out) SELinux policy statements.</p>
<p>One of the "problems" I have been facing since I took on the maintenance
of SELinux policies within Gentoo Hardened is the (seeming) inability to
make a "least privilege" policy that suits the flexibility that Gentoo
offers. As a quick recap: SELinux policies describe the "acceptable
behavior" of an application (well, domain to be exact), often known as
the "normalized behavior" in the security world. When an application
(which runs within a SELinux domain) wants to perform some action which
is not part of the policy, then this action is denied.</p>
<p>Some applications can have very broad acceptable behavior. A web server
for instance might need to connect to a database, but that is not the
case if the web server only serves static information, or dynamic
information that doesn't need a database. To support this, SELinux has
<em>booleans</em> through which optional policy statements can be enabled or
disabled. So far so good.</p>
<p>Let's look at a second example: ALSA. When ALSA enabled applications
want to access the sound devices, they use IPC resources to
"collaborate" around the sound subsystem (semaphores and shared memory
to be exact). Semaphores inherit the type of the domain that first
created the semaphore (so if <strong>mplayer</strong> creates it, then the semaphore
has the <code>mplayer_t</code> context) whereas shared memory usually gets the
tmpfs-related type (<code>mplayer_tmpfs_t</code>). When a second application wants
to access the sound device as well, it needs access to the semaphore and
shared memory. Assuming this second application is the browser, then
<code>mozilla_t</code> needs access to semaphores by <code>mplayer_t</code>. And the same for
<code>chromium_t</code>. Or <code>java_t</code> applications that are ALSA-enabled. And
<code>alsa_t</code>. And all other applications that are ALSA enabled.</p>
<p>In Gentoo, ALSA support can be made optional through <code>USE="alsa"</code>. If a
user decides not to use ALSA, then it doesn't make sense to allow all
those domains access to each others' semaphores and shared memory. And
although SELinux booleans can help, this would mean that for each
application domain, something like the following policy would need to
be, optionally, allowed:</p>
<div class="highlight"><pre><span></span><code># For the mplayer_t domain:
optional_policy(`
  tunable_policy(`use_alsa&#39;,`
    mozilla_rw_semaphores(mplayer_t)
    mozilla_rw_shm(mplayer_t)
    mozilla_tmpfs_rw_files(mplayer_t)
  &#39;)
&#39;)

optional_policy(`
  tunable_policy(`use_alsa&#39;,`
    chromium_rw_semaphores(mplayer_t)
    chromium_rw_shm(mplayer_t)
    chromium_tmpfs_rw_files(mplayer_t)
  &#39;)
&#39;)
</code></pre></div>


<p>And this for all domains that are ALSA-enabled. Every time a new
application is added that knows ALSA, the same code needs to be added to
all policies. And this only uses a single SELinux boolean (whereas
Gentoo supports <code>USE="alsa"</code> on per-package level), although we can
create separate booleans for each domain if we want to. Not that that
will make it more manageable.</p>
<p>One way of dealing with this would be to use attributes. Say we have a
policy like so:</p>
<div class="highlight"><pre><span></span><code>attribute alsadomain;
attribute alsatmpfsfile;

allow alsadomain alsadomain:sem rw_sem_perms;
allow alsadomain alsadomain:shm rw_shm_perms;
allow alsadomain alsatmpfsfile:file rw_file_perms;
</code></pre></div>


<p>By assigning the attribute to the proper domains whenever ALSA support
is needed, we can toggle this more easily:</p>
<div class="highlight"><pre><span></span><code># In alsa.if
interface(`alsa_domain&#39;,`
  gen_require(`
    attribute alsadomain;
    attribute alsatmpfsfile;
  &#39;)
  typeattribute $1 alsadomain;
  typeattribute $2 alsatmpfsfile;
&#39;)


# In mplayer.te
optional_policy(`
  tunable_policy(`use_alsa&#39;,`
    alsa_domain(mplayer_t, mplayer_tmpfs_t)
  &#39;)
&#39;)
</code></pre></div>


<p>That would solve the problem of needlessly adding more calls in a policy
for every ALSA application. And hey, we can probably live with either a
global boolean (<code>use_alsa</code>) or per-domain one (<code>mplayer_use_alsa</code>) and
toggle this according to our needs.</p>
<p>Sadly, the above is not possible: one cannot define <code>typeattribute</code>
assignments inside a <code>tunable_policy</code> code: attributes are part of the
non-conditional part of a SELinux policy. The solution would be to
create build-time conditionals (rather than run-time):</p>
<div class="highlight"><pre><span></span><code>ifdef(`use_alsa&#39;,`
  optional_policy(`
    alsa_domain(mplayer_t, mplayer_tmpfs_t)
  &#39;)
&#39;)
</code></pre></div>


<p>This does mean that <code>use_alsa</code> has to be known when the policy is built.
For Gentoo, that's not that bad, as policies are part of separate
packages, like <code>sec-policy/selinux-mplayer</code>. So what I now added was
USE-enabled build-time decisions that trigger this code. The
<code>selinux-mplayer</code> package has <code>IUSE="alsa"</code> which will enable, if set,
the <code>use_alsa</code> build-time conditional.</p>
<p>As a result, we now support a better, fine-grained privilege setting
inside the SELinux policy which is triggered through the proper USE
flags.</p>
<p>Is this a perfect solution? No, but it is manageable and known to Gentoo
users. It isn't perfect, because it listens to the USE flag setting for
the <code>selinux-mplayer</code> package (and of course globally set USE flags) but
doesn't "detect" that the firefox application (for which the policy is
meant) is or isn't built with <code>USE="alsa"</code>. So users/administrators will
need to keep this in mind when using package-local USE flag definitions.</p>
<p>Also, this will make it a bit more troublesome for myself to manage the
SELinux policy for Gentoo (as upstream will not use this setup, and as
such patches from upstream might need a few manual corrections before
they apply to our tree). However, I gladly take that up if it means my
system will have somewhat better confinement.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <p>
        To comment as a guest, use "Or sign up with disqus" and then select the "I'd rather post as guest" option.
        </p>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

                    var disqus_identifier = 'proof-of-concept-for-use-enabled-policies';
                var disqus_url = 'https://blog.siphos.be/2014/03/proof-of-concept-for-use-enabled-policies/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/sjvermeu"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
                <li class="list-group-item"><a href="https://twitter.com/sjvermeu"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.gentoo.org" target="_blank">
                Gentoo Linux
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Sven Vermeulen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.siphos.be/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.siphos.be/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.siphos.be/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'simplicityisaformofart'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>